<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YouTube会员充值</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="/static/style.css">
  <style>
    body {
      font-family: 'Microsoft YaHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      color: #343a40;
      margin: 0;
      padding: 0;
    }

    .navbar {
      background-color: #343a40;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .navbar-brand {
      font-weight: bold;
      color: white !important;
    }

    .navbar-nav .nav-link {
      color: rgba(255, 255, 255, 0.8) !important;
    }

    .navbar-nav .nav-link:hover {
      color: white !important;
    }

    .main-container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 15px;
    }

    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    .left, .right {
      flex: 1;
      min-width: 300px;
    }

    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      overflow: hidden;
    }

    .card-header {
      background-color: #007bff;
      color: white;
      padding: 15px 20px;
    }

    .card-header h2 {
      margin: 0;
      font-size: 1.5rem;
    }

    form {
      padding: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      font-weight: 500;
      margin-bottom: 8px;
      display: block;
    }

    .form-control {
      border-radius: 4px;
      border: 1px solid #ced4da;
      padding: 10px 15px;
      font-size: 16px;
    }

    textarea.form-control {
      min-height: 100px;
    }

    .btn {
      border-radius: 4px;
      padding: 10px 20px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn-primary {
      background-color: #007bff;
      border: none;
    }

    .btn-primary:hover {
      background-color: #0069d9;
    }

    .upload-container {
      border: 2px dashed #ced4da;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      position: relative;
      transition: all 0.3s ease;
      margin-bottom: 10px;
      cursor: pointer;
    }

    .upload-container:hover {
      border-color: #007bff;
    }

    .upload-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 30px 15px;
      color: #6c757d;
    }

    .upload-placeholder i {
      font-size: 40px;
      margin-bottom: 15px;
      color: #007bff;
    }

    .upload-placeholder .small {
      font-size: 12px;
      margin-top: 10px;
      color: #adb5bd;
    }

    .file-input {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    .image-preview {
      display: none;
      max-width: 100%;
      margin: 10px 0;
    }

    .image-preview img {
      max-width: 100%;
      max-height: 300px;
      border-radius: 4px;
    }

    .recent-orders {
      padding: 20px;
    }

    .recent-orders h3 {
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 1.3rem;
    }

    .recent-orders ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .recent-orders li {
      padding: 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .recent-orders li:last-child {
      border-bottom: none;
    }

    .recent-orders .order-id {
      font-weight: bold;
      color: #007bff;
    }

    .recent-orders .order-status {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-submitted {
      background-color: #ffc107;
      color: #212529;
    }

    .status-accepted {
      background-color: #17a2b8;
      color: white;
    }

    .status-completed {
      background-color: #28a745;
      color: white;
    }

    .status-failed {
      background-color: #dc3545;
      color: white;
    }

    .status-cancelled {
      background-color: #6c757d;
      color: white;
    }

    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }
      .left, .right {
        width: 100%;
      }
    }

    /* 自定义样式 */
    .balance-info {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
    }

    .balance-info i {
      font-size: 24px;
      margin-right: 15px;
      color: #28a745;
    }

    .balance-info .balance-amount {
      font-size: 18px;
      font-weight: bold;
      color: #28a745;
    }

    .balance-info .balance-label {
      font-size: 14px;
      color: #6c757d;
    }

    .drag-active {
      border-color: #28a745;
      background-color: rgba(40, 167, 69, 0.1);
    }

    /* 警告提示框 */
    .alert {
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
    }

    .alert-warning {
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      color: #856404;
    }

    .alert-info {
      background-color: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }

    /* 自定义警告框 */
    #customAlert {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 9999;
      display: none;
    }

    #customAlert.success {
      background-color: #d4edda;
      border-left: 4px solid #28a745;
      color: #155724;
    }

    #customAlert.error {
      background-color: #f8d7da;
      border-left: 4px solid #dc3545;
      color: #721c24;
    }

    #customAlert.warning {
      background-color: #fff3cd;
      border-left: 4px solid #ffc107;
      color: #856404;
    }

    .custom-alert-icon {
      margin-right: 10px;
      font-size: 18px;
    }

    .custom-alert-message {
      font-size: 14px;
    }

    /* 加载动画 */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      display: none;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- 导航栏 -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">YouTube会员充值</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
          {% if username %}
          <li class="nav-item">
            <a class="nav-link" href="/"><i class="fas fa-home"></i> 首页</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/logout"><i class="fas fa-sign-out-alt"></i> 退出</a>
          </li>
          {% else %}
          <li class="nav-item">
            <a class="nav-link" href="/login"><i class="fas fa-sign-in-alt"></i> 登录</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/register"><i class="fas fa-user-plus"></i> 注册</a>
          </li>
          {% endif %}
        </ul>
      </div>
    </div>
  </nav>

  <!-- 主内容区 -->
  <div class="main-container">
    <div class="container">
        <div class="left">
            <div class="card">
                <div class="card-header">
                  <h2>充值下单</h2>
                </div>
                <form id="orderForm" autocomplete="off" enctype="multipart/form-data">
                  <div class="form-group">
                    <label>油管二维码图片</label>
                    <div class="upload-container" id="dropArea">
                      <input name="qr_code" id="qr_code_input" type="file" class="form-control file-input" required accept="image/*" capture="environment">
                      <div class="upload-placeholder">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span>点击选择或拖拽图片到此处</span>
                        <span class="small">也可以直接粘贴截图 (Ctrl+V)</span>
                      </div>
                      <div class="image-preview" id="imagePreview"></div>
                    </div>
                    <small class="form-text text-muted">请上传您YouTube账号的二维码截图</small>
                  </div>
                  
                  <div class="form-group">
                    <label>套餐选择</label>
                    <select name="package" class="form-control">
                      {% for value, label in plan_options %}
                      <option value="{{ value }}">{{ label }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label>备注</label>
                    <textarea name="remark" class="form-control" placeholder="可选，填写额外需求"></textarea>
                  </div>
                  
                  <div class="form-group">
                    <button type="submit" class="btn btn-primary btn-block">提交订单</button>
                  </div>
                </form>
            </div>
        </div>
        
        <div class="right">
            <div class="card">
                <div class="card-header">
                    <h2>账户信息</h2>
                </div>
                <div class="p-3">
                    {% if username %}
                    <div class="balance-info">
                        <i class="fas fa-wallet"></i>
                        <div>
                            <div class="balance-amount">${{ balance }} USDT</div>
                            <div class="balance-label">账户余额</div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="alert alert-warning">
                      <strong>提示：</strong> 请确保上传的二维码图片清晰可见，系统会自动处理您的订单。
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2>最近订单</h2>
                </div>
                <div class="recent-orders" id="recent-orders">
                    <ul>
                    {% if orders %}
                        {% for order in orders %}
                        <li>
                            <span class="order-id">#{{ order[0] }}</span>
                            <span class="order-status status-{{ order[3] }}">{{ order[3] }}</span>
                        </li>
                        {% endfor %}
                    {% else %}
                        <li>暂无订单记录</li>
                    {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
  </div>

  <!-- 自定义警告框 -->
  <div id="customAlert">
    <div class="custom-alert-icon">✅</div>
    <div class="custom-alert-message">操作成功！</div>
  </div>

  <!-- 加载动画 -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
  </div>

  <!-- JS脚本 -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // 自定义警告框
    function showAlert(message, type) {
      const alert = document.getElementById('customAlert');
      const icon = alert.querySelector('.custom-alert-icon');
      const messageEl = alert.querySelector('.custom-alert-message');
      
      alert.className = '';
      alert.classList.add(type);
      
      if (type === 'success') {
        icon.innerHTML = '✅';
      } else if (type === 'error') {
        icon.innerHTML = '❌';
      } else if (type === 'warning') {
        icon.innerHTML = '⚠️';
      }
      
      messageEl.textContent = message;
      alert.style.display = 'flex';
      
      // 5秒后自动隐藏
      setTimeout(() => {
        alert.style.display = 'none';
      }, 5000);
    }
    
    // 显示加载动画
    function showLoading() {
      document.getElementById('loadingOverlay').style.display = 'flex';
    }
    
    // 隐藏加载动画
    function hideLoading() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }
    
    // 图片预览
    document.getElementById('qr_code_input').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const preview = document.getElementById('imagePreview');
      const reader = new FileReader();
      
      reader.onload = function(e) {
        preview.innerHTML = `<img src="${e.target.result}" alt="预览图">`;
        preview.style.display = 'block';
        document.querySelector('.upload-placeholder').style.display = 'none';
      };
      
      reader.readAsDataURL(file);
    });
    
    // 拖放功能
    const dropArea = document.getElementById('dropArea');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, function(e) {
        e.preventDefault();
        e.stopPropagation();
      }, false);
    });
    
    ['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, function() {
        dropArea.classList.add('drag-active');
      }, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, function() {
        dropArea.classList.remove('drag-active');
      }, false);
    });
    
    dropArea.addEventListener('drop', function(e) {
      const file = e.dataTransfer.files[0];
      if (!file) return;
      
      // 设置文件到输入框
      document.getElementById('qr_code_input').files = e.dataTransfer.files;
      
      // 触发change事件
      const event = new Event('change', { bubbles: true });
      document.getElementById('qr_code_input').dispatchEvent(event);
    });
    
    // 粘贴功能
    document.addEventListener('paste', function(e) {
      const items = (e.clipboardData || e.originalEvent.clipboardData).items;
      
      for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') === 0) {
          const blob = items[i].getAsFile();
          
          // 创建一个新的File对象
          const file = new File([blob], "pasted-image.png", { type: blob.type });
          
          // 创建一个新的FileList对象
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          
          // 设置文件到输入框
          document.getElementById('qr_code_input').files = dataTransfer.files;
          
          // 触发change事件
          const event = new Event('change', { bubbles: true });
          document.getElementById('qr_code_input').dispatchEvent(event);
          
          break;
        }
      }
    });
    
    // 提交表单
    document.getElementById('orderForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      showLoading();
      
      const formData = new FormData(this);
      
      // 获取base64图片数据（如果是粘贴的）
      const preview = document.getElementById('imagePreview');
      if (preview.style.display === 'block' && preview.querySelector('img')) {
        const imgSrc = preview.querySelector('img').src;
        if (imgSrc.startsWith('data:image')) {
          formData.append('qr_code_base64', imgSrc);
        }
      }
      
      fetch('/', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        hideLoading();
        
        if (data.success) {
          showAlert(data.message, 'success');
          // 清空表单
          document.getElementById('orderForm').reset();
          document.getElementById('imagePreview').style.display = 'none';
          document.querySelector('.upload-placeholder').style.display = 'flex';
          
          // 更新余额显示
          if (data.new_balance !== undefined) {
            document.querySelector('.balance-amount').textContent = '$' + data.new_balance + ' USDT';
          }
          
          // 刷新页面（延迟2秒）
          setTimeout(() => {
            location.reload();
          }, 2000);
        } else {
          showAlert(data.error, 'error');
        }
      })
      .catch(error => {
        hideLoading();
        showAlert('提交失败，请稍后再试', 'error');
        console.error('Error:', error);
      });
    });
    
    // 加载最近订单
    function loadRecentOrders() {
      fetch('/orders/recent')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const container = document.getElementById('recent-orders');
            const orders = data.orders;
            
            if (orders.length === 0) {
              container.innerHTML = '<p>暂无订单记录</p>';
              return;
            }
            
            let html = '<ul>';
            orders.slice(0, 5).forEach(order => {
              html += `
                <li>
                  <span class="order-id">#${order.id}</span>
                  <span class="order-status status-${order.status}">${order.status_text}</span>
                </li>
              `;
            });
            html += '</ul>';
            
            container.innerHTML = html;
          }
        })
        .catch(error => {
          console.error('Error loading recent orders:', error);
        });
    }
    
    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
      // 加载最近订单
      loadRecentOrders();
    });
  </script>
</body>
</html>
