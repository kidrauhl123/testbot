<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Spotify充值系统</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Microsoft YaHei', Arial, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0; padding: 0; min-height: 100vh;
    }
    
    /* 顶部导航栏 */
    .navbar {
      background: rgba(255,255,255,0.95);
      padding: 15px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .navbar-brand {
      font-size: 24px;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .navbar-user {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .navbar-user span {
      color: #666;
      font-size: 14px;
    }
    .navbar-user .username {
      color: #333;
      font-weight: 600;
    }
    .navbar-user .admin-badge {
      background: #ffc107;
      color: #333;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .logout-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    .logout-btn:hover {
      background: #c82333;
      transform: translateY(-1px);
    }
    
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .container { 
      display: flex; 
      min-height: calc(100vh - 100px);
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      overflow: hidden;
    }
    .left, .right { padding: 20px; }
    .left { 
      width: 50%; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
    }
    .form-box { 
      background: rgba(255,255,255,0.95); 
      padding: 40px; 
      border-radius: 15px; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.1); 
      width: 100%; 
      max-width: 420px;
      backdrop-filter: blur(10px);
    }
    .form-box h2 { 
      text-align: center; 
      font-size: 28px; 
      margin-bottom: 30px; 
      color: #333;
      font-weight: 300;
    }
    .form-box label { 
      font-weight: 600; 
      margin-top: 20px; 
      display: block; 
      color: #555;
      font-size: 14px;
    }
    .form-box input, .form-box select, .form-box button {
      width: 100%; 
      padding: 12px 15px; 
      margin-top: 8px; 
      border-radius: 8px; 
      border: 2px solid #e1e5e9; 
      font-size: 14px;
      transition: all 0.3s ease;
    }
    .form-box input:focus, .form-box select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
    }
    .form-box button { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; 
      border: none; 
      cursor: pointer; 
      font-weight: 600;
      margin-top: 25px;
      padding: 15px;
      font-size: 16px;
    }
    .form-box button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102,126,234,0.4);
    }
    .right { 
      width: 50%; 
      background: rgba(255,255,255,0.95); 
      border-radius: 15px;
      margin: 20px 0;
      overflow-y: auto; 
      backdrop-filter: blur(10px);
      max-height: calc(100vh - 140px);
    }
    .right h3 {
      color: #333;
      font-weight: 300;
      text-align: center;
      padding: 20px 0 10px;
      margin: 0;
      border-bottom: 2px solid #f0f0f0;
    }
    
    /* 搜索栏样式 */
    .search-container {
      padding: 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
    }
    .search-box {
      display: flex;
      gap: 10px;
    }
    .search-box input {
      flex: 1;
      padding: 10px 15px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    .search-box input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
    }
    .search-box button {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .search-box button:hover {
      background: #5a67d8;
      transform: translateY(-1px);
    }
    
    .order { 
      background: #f8f9fa; 
      padding: 20px; 
      margin: 15px 20px; 
      border-radius: 12px; 
      border-left: 4px solid #667eea;
      transition: all 0.3s ease;
      opacity: 1;
    }
    .order:hover {
      transform: translateX(5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .order h4 { 
      margin: 0 0 12px; 
      color: #333;
      font-size: 18px;
      font-weight: 600;
    }
    .order p { 
      margin: 8px 0; 
      font-size: 14px; 
      color: #666;
    }
    .order .time { 
      color: #999; 
      font-size: 12px; 
    }
    .order .creator {
      color: #667eea;
      font-weight: 600;
    }
    .cancel-btn { 
      display: inline-block; 
      margin-top: 12px; 
      padding: 6px 12px; 
      font-size: 12px; 
      color: #fff; 
      background: #dc3545;
      border: none;
      border-radius: 6px;
      cursor: pointer; 
      transition: all 0.3s ease;
    }
    .cancel-btn:hover {
      background: #c82333;
      transform: translateY(-1px);
    }
    .cancel-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: 600;
      color: white;
    }
    .status-submitted { background: #17a2b8; }
    .status-accepted { background: #ffc107; color: #333; }
    .status-completed { background: #28a745; }
    .status-failed { background: #dc3545; }
    .status-cancelled { background: #6c757d; }
    
    /* 加载更多按钮 */
    .load-more-container {
      text-align: center;
      padding: 20px;
    }
    .load-more-btn {
      padding: 12px 30px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .load-more-btn:hover {
      background: #5a67d8;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102,126,234,0.4);
    }
    .load-more-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    /* 无结果提示 */
    .no-results {
      text-align: center;
      color: #999;
      padding: 40px;
      font-size: 14px;
    }
    
    /* 加载动画 */
    .loading {
      text-align: center;
      padding: 20px;
      color: #667eea;
    }
    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }
    @keyframes dots {
      0%, 20% { content: ''; }
      40% { content: '.'; }
      60% { content: '..'; }
      80%, 100% { content: '...'; }
    }

    /* 平滑更新动画 */
    .order-updating {
      opacity: 0.7;
      transition: opacity 0.3s ease;
    }

    /* 自动刷新状态指示器 */
    .refresh-indicator {
      position: fixed;
      top: 80px;
      right: 20px;
      background: rgba(102, 126, 234, 0.9);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .refresh-indicator.show {
      opacity: 1;
    }

    @media (max-width: 768px) {
      .navbar {
        flex-direction: column;
        gap: 10px;
      }
      .container { flex-direction: column; }
      .left, .right { width: 100%; }
      .form-box { margin: 20px 0; }
      .search-box { flex-direction: column; }
      .search-box button { width: 100%; }
      .refresh-indicator {
        top: 100px;
        right: 10px;
        font-size: 11px;
        padding: 6px 12px;
      }
    }
  </style>
</head>
<body>
<!-- 顶部导航栏 -->
<div class="navbar">
  <div class="navbar-brand">破天充值系统</div>
  <div class="navbar-user">
    <span>欢迎，<span class="username">{{ session.username }}</span></span>
    {% if session.is_admin %}
    <span class="admin-badge">超级管理员</span>
    {% endif %}
    <button class="logout-btn" onclick="window.location.href='/logout'">退出登录</button>
  </div>
</div>

<div class="refresh-indicator" id="refreshIndicator">更新中...</div>

<div class="main-container">
  <div class="container">
    <div class="left">
      <div class="form-box">
        <h2>充值下单</h2>
        <form id="orderForm" autocomplete="off">
          <label>破天账号：</label>
          <input name="account" required autocomplete="off" placeholder="请输入您的破天账号">

          <label>密码：</label>
          <input name="password" required type="text" autocomplete="off" placeholder="请输入密码">


          <label>套餐类型：</label>
          <select name="package" required>
            <option value="1">1个月</option>
            <option value="2">2个月</option>
            <option value="3">3个月</option>
            <option value="6">6个月</option>
            <option value="12">12个月</option>
          </select>

          <label>备注（可选）：</label>
          <input name="remark" autocomplete="off" placeholder="如有特殊要求请备注">

          <button type="submit">提交订单</button>
        </form>
        
        <!-- 用户统计区域 -->
        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e1e5e9;">

          <h4 style="font-size: 16px; color: #666; margin-bottom: 10px;">今日统计</h4>
          <div id="userStats" style="font-size: 14px; color: #999;">
            <div class="loading">加载中</div>
          </div>
        </div>
      </div>
    </div>
    <div class="right">
      <h3>
        {% if session.is_admin %}
        系统订单状态<br><small style="font-weight:normal;color:#666;">（显示全部最新订单，每5秒自动更新）</small>
        {% else %}
        我的订单<br><small style="font-weight:normal;color:#666;">（显示您提交的订单，每5秒自动更新）</small>
        {% endif %}
      </h3>
      
      <!-- 搜索栏 -->
      <div class="search-container">
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="搜索订单号或账号..." autocomplete="off">
          <button onclick="searchOrders()">搜索</button>
          <button onclick="clearSearch()">清除</button>
        </div>
      </div>
      
      <div id="ordersContainer"></div>
      
      <!-- 加载更多按钮 -->
      <div class="load-more-container" id="loadMoreContainer" style="display:none;">
        <button class="load-more-btn" onclick="loadMoreOrders()">显示更多订单</button>
      </div>
    </div>
  </div>
</div>

<script>
  // 全局变量
  let displayedOrders = 5; // 初始显示5个订单
  let allOrders = []; // 存储所有订单
  let searchKeyword = ''; // 搜索关键词
  let autoRefreshInterval = null;
  let userId = '{{ session.user_id }}'; // 当前用户ID
  let isAdmin = {{ 'true' if session.is_admin else 'false' }}; // 是否是管理员
  let lastOrdersHash = ''; // 用于检测订单变化的哈希
  const WEB_PRICES = {
    '1': 12,
    '2': 18,
    '3': 30,
    '6': 50,
    '12': 84
  };
  
  let showStatLimit = 3;
  let userStatResults = [];

  
  // 生成订单数据的简单哈希
  function generateOrdersHash(orders) {
    const relevant = orders.map(o => `${o.id}-${o.status}-${o.accepted_at || ''}-${o.completed_at || ''}`).join('|');
    return btoa(relevant).substring(0, 16); // 简化的哈希
  }

  // 加载用户统计
  async function loadUserStats() {
    try {
      let targetId = userId;
      if (isAdmin) {
        const input = document.getElementById('statTargetUserId');
        if (input && input.value.trim()) {
          targetId = input.value.trim();
        }
      }
  
      const resp = await fetch(`/orders/stats/web/${targetId}`);
      const stats = await resp.json();
      
      const statsDiv = document.getElementById('userStats');
      if (stats.total_orders === 0) {
        statsDiv.innerHTML = '<div style="color: #999;">今天还没有订单</div>';
      } else {
        let html = `
          <div style="margin-bottom: 8px;">
            <strong>订单数：</strong>${stats.total_orders} 单
          </div>
          <div style="margin-bottom: 8px;">
            <strong>总金额：</strong>¥${stats.total_amount.toFixed(2)}
          </div>`;
        
        if (stats.details.length > 0) {
          html += '<div style="margin-top: 10px; font-size: 13px;">';
          stats.details.forEach(item => {
            html += `<div>• ${item.package}：${item.count}单 (¥${item.amount.toFixed(2)})</div>`;
          });
          html += '</div>';
        }
        
        statsDiv.innerHTML = html;
      }
    } catch (e) {
      console.error('加载统计失败', e);
    }
  }
  function buildUserStatsFromOrders(allOrders) {
    const map = new Map();
  
    for (const order of allOrders) {
      const username = order.creator;
      if (!username) continue;
  
      if (!map.has(username)) {
        map.set(username, {
          username,
          total_orders: 0,
          total_amount: 0,
          package_counts: {}
        });
      }
  
      const stats = map.get(username);
      stats.total_orders += 1;
  
      if (order.status === 'completed') {
        const price = WEB_PRICES[order.package] || 0;
        stats.total_amount += price;
      }
  
      const pkg = order.package;
      stats.package_counts[pkg] = (stats.package_counts[pkg] || 0) + 1;
    }
  
    return Array.from(map.values()).sort((a, b) => b.total_amount - a.total_amount);
  }

  function renderAdminStatsList() {
    const statsDiv = document.getElementById('userStats');
    const toShow = userStatResults.slice(0, showStatLimit);
  
    let html = '';
    for (const stat of toShow) {
      html += `
        <div style="margin-bottom:15px;">
          <strong>@${stat.username}</strong><br>
          订单数：${stat.total_orders} 单<br>
          总金额：¥${stat.total_amount.toFixed(2)}<br>`;
  
      for (const [pkg, count] of Object.entries(stat.package_counts)) {
        const amount = (WEB_PRICES[pkg] || 0) * count;
        html += `<div style="font-size:13px;">• ${pkg}月：${count} 单 (¥${amount.toFixed(2)})</div>`;
      }
  
      html += `</div>`;
    }
  
    if (userStatResults.length > showStatLimit) {
      html += `<button onclick="showStatLimit += 3; renderAdminStatsList()" style="margin-top:10px;">显示更多</button>`;
    }
  
    statsDiv.innerHTML = html;
  }
    
  // 提交订单
  document.getElementById('orderForm').addEventListener('submit', async e => {
    e.preventDefault();
    const btn = e.target.querySelector('button');
    const orig = btn.textContent;
    btn.textContent = '提交中…';
    btn.disabled = true;
    try {
      const data = new FormData(e.target);
      
      const resp = await fetch('/', { method: 'POST', body: data });
      if (!resp.ok) throw new Error('提交失败');
      
      // 重置表单和状态
      e.target.reset();
      displayedOrders = 5;
      searchKeyword = '';
      document.getElementById('searchInput').value = '';
      
      // 立即刷新订单和统计
      await loadOrders();
      await loadUserStats();
      
      alert('订单提交成功！');
    } catch (error) {
      alert(error.message || '提交失败，请重试');
    } finally {
      btn.textContent = orig;
      btn.disabled = false;
    }
  });

  // 加载订单
  async function loadOrders(showIndicator = true) {
    try {
      if (showIndicator) {
        showRefreshIndicator();
      }
      
      const resp = await fetch('/orders/recent');
      const newOrders = await resp.json();
      
      // 检查订单是否有变化
      const newHash = generateOrdersHash(newOrders);
      if (newHash === lastOrdersHash && allOrders.length > 0) {
        // 没有变化，不需要重新渲染
        if (showIndicator) {
          hideRefreshIndicator();
        }
        return;
      }
      
      lastOrdersHash = newHash;
      allOrders = newOrders;
      
      // 应用搜索过滤
      let filteredOrders = allOrders;
      if (searchKeyword) {
        filteredOrders = allOrders.filter(order => 
          order.id.toString().includes(searchKeyword) || 
          order.account.toLowerCase().includes(searchKeyword.toLowerCase())
        );
      }
      
      renderOrders(filteredOrders);
      
      if (showIndicator) {
        setTimeout(hideRefreshIndicator, 300);
      }
    } catch (e) {
      console.error('加载订单失败', e);
      document.getElementById('ordersContainer').innerHTML = 
        '<div class="no-results">加载失败，请刷新重试</div>';
      if (showIndicator) {
        hideRefreshIndicator();
      }
    }
  }

  // 显示刷新指示器
  function showRefreshIndicator() {
    const indicator = document.getElementById('refreshIndicator');
    indicator.classList.add('show');
  }

  // 隐藏刷新指示器
  function hideRefreshIndicator() {
    const indicator = document.getElementById('refreshIndicator');
    indicator.classList.remove('show');
  }

  // 渲染订单
  function renderOrders(orders) {
    const container = document.getElementById('ordersContainer');
    const loadMoreBtn = document.getElementById('loadMoreContainer');
    
    if (!orders.length) {
      container.innerHTML = '<div class="no-results">暂无订单</div>';
      loadMoreBtn.style.display = 'none';
      return;
    }
    
    // 确保 displayedOrders 至少为 5
    if (displayedOrders < 5) {
      displayedOrders = Math.min(5, orders.length);
    }
    
    // 只显示指定数量的订单
    const ordersToShow = orders.slice(0, displayedOrders);
    
    container.innerHTML = '';
    ordersToShow.forEach(o => {
      const cls = 'status-' + o.status.replace('已','').toLowerCase();
      
      const html = `
        <div class="order" data-order-id="${o.id}">
          <h4>订单 #${o.id} <span class="status-badge ${cls}">${o.status_text}</span></h4>
          ${isAdmin && o.creator ? `<p class="creator">创建者：${escapeHtml(o.creator)}</p>` : ''}
          ${isAdmin && o.accepted_by ? `<p class="creator">接单者：@${escapeHtml(o.accepted_by)}</p>` : ''}
          <p><strong>账号：</strong>${escapeHtml(o.account)}</p>
          <p><strong>套餐：</strong>${escapeHtml(o.package)}个月</p>
          <p><strong>价格：</strong>¥${WEB_PRICES[o.package] || 'N/A'}</p>
          ${o.remark ? `<p><strong>备注：</strong>${escapeHtml(o.remark)}</p>` : ''}
          <p class="time"><strong>提交时间：</strong>${o.created_at}</p>
          ${o.accepted_at ? `<p class="time"><strong>接单时间：</strong>${o.accepted_at}</p>` : ''}
          ${o.completed_at ? `<p class="time"><strong>完成时间：</strong>${o.completed_at}</p>` : ''}
          ${o.can_cancel ? `<button class="cancel-btn" onclick="cancelOrder(${o.id}, this)">撤销订单</button>` : ''}
        </div>`;
      container.insertAdjacentHTML('beforeend', html);
    });
    
    // 显示或隐藏"加载更多"按钮
    if (orders.length > displayedOrders) {
      loadMoreBtn.style.display = 'block';
      loadMoreBtn.querySelector('button').textContent = 
        `显示更多订单 (${ordersToShow.length}/${orders.length})`;
    } else {
      loadMoreBtn.style.display = 'none';
    }
  }

  // 加载更多订单
  function loadMoreOrders() {
    displayedOrders += 10; // 每次多显示10个
    const filteredOrders = searchKeyword ? 
      allOrders.filter(order => 
        order.id.toString().includes(searchKeyword) || 
        order.account.toLowerCase().includes(searchKeyword.toLowerCase())
      ) : allOrders;
    renderOrders(filteredOrders);
  }

  // 搜索订单
  function searchOrders() {
    searchKeyword = document.getElementById('searchInput').value.trim();
    displayedOrders = 5; // 重置显示数量
    
    if (!searchKeyword) {
      renderOrders(allOrders);
      return;
    }
    
    const filteredOrders = allOrders.filter(order => 
      order.id.toString().includes(searchKeyword) || 
      order.account.toLowerCase().includes(searchKeyword.toLowerCase())
    );
    
    renderOrders(filteredOrders);
  }

  // 清除搜索
  function clearSearch() {
    searchKeyword = '';
    document.getElementById('searchInput').value = '';
    displayedOrders = 5;
    renderOrders(allOrders);
  }

  // 监听回车键搜索
  document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      searchOrders();
    }
  });

  // HTML转义函数
  function escapeHtml(unsafe) {
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // 撤销订单
  async function cancelOrder(id, buttonElement) {
    if (!confirm('确定要撤销此订单吗？')) return;
    
    // 禁用按钮
    buttonElement.disabled = true;
    buttonElement.textContent = '撤销中...';
    
    try {
      const resp = await fetch('/orders/cancel/' + id, { method: 'POST' });
      if (resp.ok) {
        // 立即更新显示
        await loadOrders(false);
        alert('订单已撤销');
      } else {
        alert('撤销失败');
        buttonElement.disabled = false;
        buttonElement.textContent = '撤销订单';
      }
    } catch (e) {
      alert('撤销失败，请重试');
      buttonElement.disabled = false;
      buttonElement.textContent = '撤销订单';
    }
  }

  // 自动刷新管理
  function startAutoRefresh() {
    stopAutoRefresh(); // 先停止现有的
    autoRefreshInterval = setInterval(() => {
      // 如果没有搜索关键词，则自动刷新
      if (!searchKeyword) {
        loadOrders(true);
      }
    }, 5000); // 改为5秒刷新一次，减少频率
  }

  function stopAutoRefresh() {
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
      autoRefreshInterval = null;
    }
  }

  // 页面可见性改变时的处理
  document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
      stopAutoRefresh();
    } else {
      startAutoRefresh();
    }
  });

  // 初始化
  window.addEventListener('load', async () => {
    await loadOrders();
    if (isAdmin) {
      userStatResults = buildUserStatsFromOrders(allOrders);
      renderAdminStatsList();
    } else {
      await loadUserStats();
    }
    startAutoRefresh();
  });


  // 页面卸载时清理
  window.addEventListener('beforeunload', () => {
    stopAutoRefresh();
  });
</script>

</body>
</html>
