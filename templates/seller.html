<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>å–å®¶ç®¡ç† - ç ´å¤©å……å€¼ç³»ç»Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Microsoft YaHei', Arial, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0; padding: 0; min-height: 100vh;
    }
    
    /* é¡¶éƒ¨å¯¼èˆªæ  */
    .navbar {
      background: rgba(255,255,255,0.95);
      padding: 15px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .navbar-brand {
      font-size: 24px;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .navbar-user {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .navbar-user span {
      color: #666;
      font-size: 14px;
    }
    .navbar-user .username {
      color: #333;
      font-weight: 600;
    }
    .admin-badge {
      background: #ffc107;
      color: #333;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .btn {
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }
    .btn:hover {
      transform: translateY(-1px);
    }
    .btn-primary { background: #667eea; color: white; }
    .btn-primary:hover { background: #5a67d8; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-danger:hover { background: #c82333; }
    .btn-success { background: #28a745; color: white; }
    .btn-success:hover { background: #218838; }
    .btn-warning { background: #ffc107; color: #333; }
    .btn-warning:hover { background: #e0a800; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-secondary:hover { background: #5a6268; }
    
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .card {
      background: rgba(255,255,255,0.95);
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }
    
    .card h2 {
      color: #333;
      font-weight: 300;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .form-group {
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      align-items: end;
    }
    
    .form-group input {
      flex: 1;
      padding: 12px 15px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
    }
    
    .form-group label {
      font-weight: 600;
      color: #555;
      font-size: 14px;
      margin-bottom: 5px;
      display: block;
    }
    
    .seller-list {
      margin-top: 30px;
    }
    
    .seller-item {
      background: #f8f9fa;
      padding: 20px;
      margin-bottom: 15px;
      border-radius: 12px;
      border-left: 4px solid #667eea;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }
    
    .seller-item:hover {
      transform: translateX(5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .seller-info h4 {
      margin: 0 0 8px;
      color: #333;
      font-size: 18px;
      font-weight: 600;
    }
    
    .seller-info p {
      margin: 4px 0;
      font-size: 14px;
      color: #666;
    }
    
    .seller-info .telegram-id {
      font-family: 'Courier New', monospace;
      background: #e9ecef;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 13px;
    }
    
    .seller-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: 600;
      margin-right: 15px;
    }
    
    .status-active {
      background: #28a745;
      color: white;
    }
    
    .status-inactive {
      background: #6c757d;
      color: white;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #667eea;
    }
    
    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: ''; }
      40% { content: '.'; }
      60% { content: '..'; }
      80%, 100% { content: '...'; }
    }
    
    .error-message {
      background: #fee;
      color: #c33;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }
    
    .success-message {
      background: #efe;
      color: #3c3;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }
    
    .instructions {
      background: #e3f2fd;
      border: 1px solid #2196f3;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
    }
    
    .instructions h3 {
      color: #1976d2;
      margin-top: 0;
      margin-bottom: 15px;
    }
    
    .instructions ul {
      margin-bottom: 0;
      padding-left: 20px;
    }
    
    .instructions li {
      margin-bottom: 8px;
      color: #555;
    }
    
    .instructions code {
      background: #fff;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }
    
    @media (max-width: 768px) {
      .navbar {
        flex-direction: column;
        gap: 10px;
      }
      .form-group {
        flex-direction: column;
        align-items: stretch;
      }
      .seller-item {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
      }
      .seller-actions {
        justify-content: flex-end;
      }
    }
  </style>
</head>
<body>
<!-- é¡¶éƒ¨å¯¼èˆªæ  -->
<div class="navbar">
  <div class="navbar-brand">ç ´å¤©å……å€¼ç³»ç»Ÿ - å–å®¶ç®¡ç†</div>
  <div class="navbar-user">
    <a href="/" class="btn btn-primary">è¿”å›ä¸»é¡µ</a>
    <span>æ¬¢è¿ï¼Œ<span class="username">è¶…çº§ç®¡ç†å‘˜</span></span>
    <span class="admin-badge">è¶…çº§ç®¡ç†å‘˜</span>
    <button class="btn btn-danger" onclick="window.location.href='/logout'">é€€å‡ºç™»å½•</button>
  </div>
</div>

<div class="main-container">
  <!-- ä½¿ç”¨è¯´æ˜ -->
  <div class="instructions">
    <h3>ğŸ“‹ å–å®¶ç®¡ç†è¯´æ˜</h3>
    <ul>
      <li><strong>æ·»åŠ å–å®¶ï¼š</strong>è¾“å…¥è¦æ·»åŠ çš„Telegramç”¨æˆ·IDï¼Œç‚¹å‡»æ·»åŠ æŒ‰é’®</li>
      <li><strong>è·å–Telegram IDï¼š</strong>å¯ä»¥è®©ç”¨æˆ·å‘é€ <code>/start</code> ç»™ <code>@userinfobot</code> è·å–è‡ªå·±çš„ID</li>
      <li><strong>åœç”¨/å¯ç”¨ï¼š</strong>ç‚¹å‡»åˆ‡æ¢æŒ‰é’®å¯ä»¥ä¸´æ—¶åœç”¨æˆ–é‡æ–°å¯ç”¨å–å®¶æƒé™</li>
      <li><strong>åˆ é™¤å–å®¶ï¼š</strong>ç‚¹å‡»åˆ é™¤æŒ‰é’®æ°¸ä¹…ç§»é™¤å–å®¶ï¼ˆè°¨æ…æ“ä½œï¼‰</li>
      <li><strong>å®æ—¶ç”Ÿæ•ˆï¼š</strong>æ‰€æœ‰æ“ä½œç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡æ–°éƒ¨ç½²</li>
    </ul>
  </div>
  
  <!-- æ·»åŠ æ–°å–å®¶ -->
  <div class="card">
    <h2>â• æ·»åŠ æ–°çš„å–å®¶</h2>
    
    <div id="message"></div>
    
    <div class="form-group">
      <div style="flex: 1;">
        <label>Telegramç”¨æˆ·ID *</label>
        <input type="number" id="telegramId" placeholder="ä¾‹å¦‚: 1234567890" required>
      </div>
      <div style="flex: 1;">
        <label>ç”¨æˆ·åï¼ˆå¯é€‰ï¼‰</label>
        <input type="text" id="username" placeholder="ä¾‹å¦‚: john_doe">
      </div>
      <div style="flex: 1;">
        <label>å§“åï¼ˆå¯é€‰ï¼‰</label>
        <input type="text" id="firstName" placeholder="ä¾‹å¦‚: John">
      </div>
      <button class="btn btn-success" onclick="addSeller()" id="addBtn">
        æ·»åŠ å–å®¶
      </button>
    </div>
  </div>
  
  <!-- ç°æœ‰å–å®¶åˆ—è¡¨ -->
  <div class="card">
    <h2>ğŸ‘¥ ç°æœ‰å–å®¶</h2>
    
    <div id="sellersList">
      <div class="loading">åŠ è½½å–å®¶åˆ—è¡¨ä¸­</div>
    </div>
  </div>
</div>

<script>
let sellers = [];

// æ˜¾ç¤ºæ¶ˆæ¯
function showMessage(text, type = 'success') {
  const messageDiv = document.getElementById('message');
  messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
  messageDiv.textContent = text;
  messageDiv.style.display = 'block';
  
  setTimeout(() => {
    messageDiv.style.display = 'none';
  }, 5000);
}

// åŠ è½½å–å®¶åˆ—è¡¨
async function loadSellers() {
  try {
    const response = await fetch('/admin/sellers');
    if (!response.ok) {
      throw new Error('Failed to load sellers');
    }
    
    sellers = await response.json();
    renderSellers();
  } catch (error) {
    console.error('Error loading sellers:', error);
    document.getElementById('sellersList').innerHTML = 
      '<div class="error-message" style="display: block;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
  }
}

// æ¸²æŸ“å–å®¶åˆ—è¡¨
function renderSellers() {
  const container = document.getElementById('sellersList');
  
  if (!sellers.length) {
    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">æš‚æ— å–å®¶</div>';
    return;
  }
  
  container.innerHTML = '';
  
  sellers.forEach(seller => {
    const sellerDiv = document.createElement('div');
    sellerDiv.className = 'seller-item';
    
    const name = seller.first_name || 'Unknown';
    const username = seller.username ? `@${seller.username}` : 'æ— ç”¨æˆ·å';
    const statusClass = seller.is_active ? 'status-active' : 'status-inactive';
    const statusText = seller.is_active ? 'âœ… æ´»è·ƒ' : 'âŒ å·²åœç”¨';
    const addedDate = new Date(seller.added_at).toLocaleString('zh-CN');
    
    sellerDiv.innerHTML = `
      <div class="seller-info">
        <h4>${escapeHtml(name)} <span class="status-badge ${statusClass}">${statusText}</span></h4>
        <p><strong>ç”¨æˆ·åï¼š</strong>${escapeHtml(username)}</p>
        <p><strong>Telegram IDï¼š</strong><span class="telegram-id">${seller.telegram_id}</span></p>
        <p><strong>æ·»åŠ æ—¶é—´ï¼š</strong>${addedDate}</p>
        ${seller.added_by ? `<p><strong>æ·»åŠ è€…ï¼š</strong>${escapeHtml(seller.added_by)}</p>` : ''}
      </div>
      <div class="seller-actions">
        <button class="btn ${seller.is_active ? 'btn-warning' : 'btn-success'}" 
                onclick="toggleSeller(${seller.telegram_id})">
          ${seller.is_active ? 'åœç”¨' : 'å¯ç”¨'}
        </button>
        <button class="btn btn-danger" onclick="removeSeller(${seller.telegram_id})">
          åˆ é™¤
        </button>
      </div>
    `;
    
    container.appendChild(sellerDiv);
  });
}

// HTMLè½¬ä¹‰
function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// æ·»åŠ å–å®¶
async function addSeller() {
  const telegramId = document.getElementById('telegramId').value.trim();
  const username = document.getElementById('username').value.trim();
  const firstName = document.getElementById('firstName').value.trim();
  
  if (!telegramId) {
    showMessage('è¯·è¾“å…¥Telegramç”¨æˆ·ID', 'error');
    return;
  }
  
  if (!/^\d+$/.test(telegramId)) {
    showMessage('Telegram IDå¿…é¡»æ˜¯æ•°å­—', 'error');
    return;
  }
  
  const addBtn = document.getElementById('addBtn');
  const originalText = addBtn.textContent;
  addBtn.textContent = 'æ·»åŠ ä¸­...';
  addBtn.disabled = true;
  
  try {
    const response = await fetch('/admin/sellers', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        telegram_id: parseInt(telegramId),
        username: username || null,
        first_name: firstName || null
      })
    });
    
    const result = await response.json();
    
    if (response.ok) {
      showMessage('å–å®¶æ·»åŠ æˆåŠŸï¼', 'success');
      // æ¸…ç©ºè¡¨å•
      document.getElementById('telegramId').value = '';
      document.getElementById('username').value = '';
      document.getElementById('firstName').value = '';
      // é‡æ–°åŠ è½½åˆ—è¡¨
      await loadSellers();
    } else {
      showMessage(result.error || 'æ·»åŠ å¤±è´¥', 'error');
    }
  } catch (error) {
    console.error('Error adding seller:', error);
    showMessage('æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
  } finally {
    addBtn.textContent = originalText;
    addBtn.disabled = false;
  }
}

// åˆ‡æ¢å–å®¶çŠ¶æ€
async function toggleSeller(telegramId) {
  if (!confirm('ç¡®å®šè¦åˆ‡æ¢æ­¤å–å®¶çš„çŠ¶æ€å—ï¼Ÿ')) {
    return;
  }
  
  try {
    const response = await fetch(`/admin/sellers/${telegramId}/toggle`, {
      method: 'POST'
    });
    
    const result = await response.json();
    
    if (response.ok) {
      showMessage('çŠ¶æ€åˆ‡æ¢æˆåŠŸï¼', 'success');
      await loadSellers();
    } else {
      showMessage(result.error || 'æ“ä½œå¤±è´¥', 'error');
    }
  } catch (error) {
    console.error('Error toggling seller:', error);
    showMessage('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
  }
}

// åˆ é™¤å–å®¶
async function removeSeller(telegramId) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤å–å®¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
    return;
  }
  
  try {
    const response = await fetch(`/admin/sellers/${telegramId}`, {
      method: 'DELETE'
    });
    
    const result = await response.json();
    
    if (response.ok) {
      showMessage('å–å®¶åˆ é™¤æˆåŠŸï¼', 'success');
      await loadSellers();
    } else {
      showMessage(result.error || 'åˆ é™¤å¤±è´¥', 'error');
    }
  } catch (error) {
    console.error('Error removing seller:', error);
    showMessage('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
  }
}

// ç›‘å¬å›è½¦é”®
document.getElementById('telegramId').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    addSeller();
  }
});

document.getElementById('username').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    addSeller();
  }
});

document.getElementById('firstName').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    addSeller();
  }
});

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
window.addEventListener('load', () => {
  loadSellers();
});
</script>

</body>
</html>