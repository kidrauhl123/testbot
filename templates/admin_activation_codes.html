<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>激活码管理</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .code-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            padding: 10px;
            background-color: #f8f9fa;
        }
        .table-responsive {
            min-height: 400px;
        }
        .badge-used {
            background-color: #dc3545;
        }
        .badge-unused {
            background-color: #28a745;
        }
        .copy-btn {
            cursor: pointer;
        }
        .copy-btn:hover {
            color: #0d6efd;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-3">
                <!-- 侧边栏 -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        管理菜单
                    </div>
                    <div class="list-group list-group-flush">
                        <a href="/admin" class="list-group-item list-group-item-action">
                            <i class="bi bi-speedometer2 me-2"></i>仪表盘
                        </a>
                        <a href="/admin/activation-codes" class="list-group-item list-group-item-action active">
                            <i class="bi bi-key me-2"></i>激活码管理
                        </a>
                        <a href="/admin/recharge-requests" class="list-group-item list-group-item-action">
                            <i class="bi bi-cash-coin me-2"></i>充值管理
                        </a>
                        <a href="/" class="list-group-item list-group-item-action">
                            <i class="bi bi-house me-2"></i>返回前台
                        </a>
                        <a href="/logout" class="list-group-item list-group-item-action text-danger">
                            <i class="bi bi-box-arrow-right me-2"></i>退出登录
                        </a>
                    </div>
                </div>
            </div>

            <div class="col-md-9">
                <!-- 主内容区 -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">生成激活码</h5>
                    </div>
                    <div class="card-body">
                        <form id="generateForm" class="row g-3">
                            <div class="col-md-4">
                                <label for="package" class="form-label">套餐</label>
                                <select class="form-select" id="package" name="package" required>
                                    <option value="">选择套餐</option>
                                    <option value="1">1个月</option>
                                    <option value="3">3个月</option>
                                    <option value="6">6个月</option>
                                    <option value="12">12个月</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="count" class="form-label">生成数量</label>
                                <input type="number" class="form-control" id="count" name="count" min="1" max="100" value="1" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">&nbsp;</label>
                                <button type="submit" class="btn btn-primary w-100">生成激活码</button>
                            </div>
                        </form>
                        
                        <div id="generatedCodes" class="mt-3 d-none">
                            <h6>生成的激活码：</h6>
                            <div class="code-container mb-2" id="codesList"></div>
                            <div class="d-flex justify-content-between">
                                <button class="btn btn-sm btn-outline-primary" id="copyAllBtn">
                                    <i class="bi bi-clipboard me-1"></i>复制全部
                                </button>
                                <button class="btn btn-sm btn-outline-primary" id="copyWithLinksBtn">
                                    <i class="bi bi-link-45deg me-1"></i>复制带链接的激活码
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">激活码列表</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>激活码</th>
                                        <th>套餐</th>
                                        <th>状态</th>
                                        <th>创建时间</th>
                                        <th>使用时间</th>
                                        <th>创建者</th>
                                        <th>使用者</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="codesTableBody">
                                    <tr>
                                        <td colspan="9" class="text-center">加载中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const baseUrl = window.location.origin;
            
            // 加载激活码列表
            loadActivationCodes();
            
            // 生成激活码表单提交
            document.getElementById('generateForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const package = document.getElementById('package').value;
                const count = document.getElementById('count').value;
                
                if (!package) {
                    alert('请选择套餐');
                    return;
                }
                
                fetch('/admin/api/activation-codes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ package, count })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 显示生成的激活码
                        showGeneratedCodes(data.codes);
                        // 重新加载列表
                        loadActivationCodes();
                    } else {
                        alert(data.message || '生成激活码失败');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('请求失败，请稍后再试');
                });
            });
            
            // 复制全部激活码
            document.getElementById('copyAllBtn').addEventListener('click', function() {
                const codesList = document.querySelectorAll('#codesList .code-text');
                let allCodes = '';
                
                codesList.forEach(code => {
                    allCodes += code.textContent + '\n';
                });
                
                copyToClipboard(allCodes);
                alert('已复制全部激活码');
            });
            
            // 复制带链接的激活码
            document.getElementById('copyWithLinksBtn').addEventListener('click', function() {
                const codesList = document.querySelectorAll('#codesList .code-text');
                let allCodes = '';
                
                codesList.forEach(code => {
                    const codeText = code.textContent;
                    allCodes += `${codeText} - ${baseUrl}/redeem/${codeText}\n`;
                });
                
                copyToClipboard(allCodes);
                alert('已复制带链接的激活码');
            });
            
            // 显示生成的激活码
            function showGeneratedCodes(codes) {
                const codesListEl = document.getElementById('codesList');
                codesListEl.innerHTML = '';
                
                codes.forEach(code => {
                    const codeEl = document.createElement('div');
                    codeEl.className = 'd-flex justify-content-between align-items-center mb-1';
                    codeEl.innerHTML = `
                        <span class="code-text">${code.code}</span>
                        <i class="bi bi-clipboard copy-btn" data-code="${code.code}" title="复制"></i>
                    `;
                    codesListEl.appendChild(codeEl);
                });
                
                // 添加复制单个激活码的事件
                document.querySelectorAll('#codesList .copy-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const code = this.getAttribute('data-code');
                        copyToClipboard(code);
                        alert(`已复制激活码: ${code}`);
                    });
                });
                
                document.getElementById('generatedCodes').classList.remove('d-none');
            }
            
            // 加载激活码列表
            function loadActivationCodes() {
                fetch('/admin/api/activation-codes')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderActivationCodes(data.codes);
                    } else {
                        document.getElementById('codesTableBody').innerHTML = `
                            <tr>
                                <td colspan="9" class="text-center text-danger">${data.message || '加载失败'}</td>
                            </tr>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('codesTableBody').innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center text-danger">请求失败，请稍后再试</td>
                        </tr>
                    `;
                });
            }
            
            // 渲染激活码列表
            function renderActivationCodes(codes) {
                const tableBody = document.getElementById('codesTableBody');
                
                if (codes.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center">暂无激活码</td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                
                codes.forEach(code => {
                    html += `
                        <tr>
                            <td>${code.id}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <span class="me-2">${code.code}</span>
                                    <i class="bi bi-clipboard copy-btn" data-code="${code.code}" title="复制"></i>
                                </div>
                            </td>
                            <td>${code.package}个月</td>
                            <td>
                                <span class="badge ${code.is_used ? 'bg-danger' : 'bg-success'}">
                                    ${code.is_used ? '已使用' : '未使用'}
                                </span>
                            </td>
                            <td>${code.created_at}</td>
                            <td>${code.used_at || '-'}</td>
                            <td>${code.creator || '-'}</td>
                            <td>${code.user || '-'}</td>
                            <td>
                                <div class="d-flex">
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="copyRedeemLink('${code.code}')">
                                        <i class="bi bi-link-45deg"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCode(${code.id})" ${code.is_used ? 'disabled' : ''}>
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableBody.innerHTML = html;
                
                // 添加复制激活码的事件
                document.querySelectorAll('#codesTableBody .copy-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const code = this.getAttribute('data-code');
                        copyToClipboard(code);
                        alert(`已复制激活码: ${code}`);
                    });
                });
            }
            
            // 复制到剪贴板
            function copyToClipboard(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
            }
            
            // 复制兑换链接
            window.copyRedeemLink = function(code) {
                const link = `${baseUrl}/redeem/${code}`;
                copyToClipboard(link);
                alert(`已复制兑换链接: ${link}`);
            };
            
            // 删除激活码
            window.deleteCode = function(id) {
                if (!confirm('确定要删除这个激活码吗？此操作不可撤销。')) {
                    return;
                }
                
                fetch(`/admin/api/activation-codes/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('删除成功');
                        loadActivationCodes();
                    } else {
                        alert(data.message || '删除失败');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('请求失败，请稍后再试');
                });
            };
        });
    </script>
</body>
</html> 