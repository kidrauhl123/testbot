<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Á≥ªÁªüÁÆ°ÁêÜÂêéÂè∞ - Á†¥Â§©ÂÖÖÂÄºÁ≥ªÁªü</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Microsoft YaHei', Arial, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0; padding: 0; min-height: 100vh;
      color: #333;
    }
    
    .navbar {
      background: rgba(255,255,255,0.95);
      padding: 15px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .navbar-brand {
      font-size: 24px;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .navbar-user {
      display: flex;
      align-items: center;
      gap: 20px;
      position: relative;
    }
    .admin-badge {
      background: linear-gradient(135deg, #ffb347 0%, #ffcc33 100%);
      color: #333;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 2px 5px rgba(255,195,51,0.3);
    }
    .btn {
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }
    .btn:hover {
      transform: translateY(-1px);
    }
    .btn-primary { background: #667eea; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    
    .main-container {
      max-width: 1400px;
      margin: 20px auto;
      padding: 20px;
    }
    
    .admin-container {
      display: flex;
      gap: 20px;
    }
    
    .sidebar {
      width: 240px;
      flex-shrink: 0;
      background: rgba(255,255,255,0.95);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
      align-self: flex-start;
    }
    
    .sidebar-menu {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .sidebar-menu a {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      color: #333;
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    
    .sidebar-menu a:hover, .sidebar-menu a.active {
      background: #667eea;
      color: white;
    }
    
    .sidebar-menu i {
      margin-right: 12px;
      width: 20px;
      text-align: center;
    }
    
    .content {
      flex: 1;
      background: rgba(255,255,255,0.95);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .content-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .content-header h2 {
      margin: 0;
      font-weight: 400;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    .data-table th, .data-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #e9ecef;
      vertical-align: middle;
    }
    .data-table th {
      background: #f8f9fa;
      font-weight: 600;
    }
    .data-table tr:hover {
      background: #f8f9fa;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
    }
    .badge-success { background: #28a745; color: white; }
    .badge-warning { background: #ffc107; color: #333; }
    .badge-danger { background: #dc3545; color: white; }
    .badge-info { background: #17a2b8; color: white; }
    .badge-secondary { background: #6c757d; color: white; }

    .loading {
      text-align: center;
      padding: 50px;
      color: #667eea;
    }
    
    /* ÊúÄÂ§ßÊé•ÂçïÊï∞ËæìÂÖ•Ê°ÜÊ†∑Âºè */
    .max-orders-input {
      width: 80px;
      display: inline-block;
      text-align: center;
    }
    
    /* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
    .modal-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-backdrop.show {
      display: flex !important;
    }
    
    .modal {
      background: white;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      overflow: hidden;
      z-index: 1001;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
    }
    
    .modal-header h3 {
      margin: 0;
      font-weight: 500;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .form-control {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    
    .error-message {
      color: #dc3545;
      margin-bottom: 15px;
      padding: 8px;
      background: #f8d7da;
      border-radius: 5px;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    /* Áî®Êà∑‰∏ãÊãâËèúÂçïÊ†∑Âºè */
    .user-dropdown {
      position: relative;
      display: inline-block;
      cursor: pointer;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 6px 12px;
      border-radius: 20px;
      background-color: rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }

    .user-info:hover {
      background-color: rgba(0,0,0,0.1);
    }

    .user-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background-color: #764ba2;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
    }

    .user-name {
      font-weight: 600;
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      width: 200px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      padding: 10px 0;
      margin-top: 10px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .user-dropdown:hover .dropdown-menu {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .dropdown-menu::before {
      content: '';
      position: absolute;
      top: -6px;
      right: 20px;
      width: 12px;
      height: 12px;
      background-color: white;
      transform: rotate(45deg);
      border-radius: 2px;
    }

    .dropdown-menu-item {
      padding: 8px 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: #333;
      text-decoration: none;
      transition: all 0.2s ease;
    }

    .dropdown-menu-item:hover {
      background-color: rgba(0,0,0,0.05);
    }

    .dropdown-menu-item.danger {
      color: #e74c3c;
    }

    .dropdown-menu-item.danger:hover {
      background-color: rgba(231,76,60,0.1);
    }

    .dropdown-divider {
      height: 1px;
      background-color: rgba(0,0,0,0.1);
      margin: 5px 0;
    }

    .dropdown-menu-header {
      padding: 8px 15px;
      font-size: 12px;
      color: #666;
      font-weight: 600;
    }
    
    .balance-badge {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 2px 5px rgba(56,239,125,0.3);
      display: flex;
      align-items: center;
    }
    
    .balance-badge.negative {
      background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
    }
    
    .balance-badge::before {
      content: 'üí∞';
      margin-right: 5px;
    }

    /* -- ÁßªÂä®Á´ØÂìçÂ∫îÂºè -- */
    @media (max-width: 768px) {
      .navbar { flex-wrap: wrap; padding: 10px; }
      .navbar-brand { font-size: 18px; }
      .navbar-user { gap: 10px; }

      .admin-container { flex-direction: column; }
      .sidebar {
        width: 100%;
        margin-bottom: 15px;
        flex-direction: row;
        overflow-x: auto;
      }
      .sidebar-menu {
        display: flex;
        gap: 8px;
      }
      .sidebar-menu a {
        flex: 1 0 auto;
        justify-content: center;
        padding: 10px 8px;
      }
      .content {
        padding: 15px 10px;
      }
      .main-container {
        max-width: 100%;
        margin: 10px auto;
        padding: 0 10px;
      }
      /* ËÆ©ÂÆΩË°®Ê®™ÂêëÊªöÂä® */
      .data-table {
        display: block;
        width: 100%;
        overflow-x: auto;
        white-space: nowrap;
      }
      .data-table th, .data-table td {
        font-size: 12px;
      }
    }

    /* Âü∫Êú¨Ê†∑Âºè */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    
    /* Ë°®Ê†ºÂÆπÂô® - ÊîØÊåÅËôöÊãüÊªöÂä® */
    .table-container {
      max-height: 70vh; /* ÊúÄÂ§ßÈ´òÂ∫¶‰∏∫ËßÜÁ™óÈ´òÂ∫¶ÁöÑ70% */
      overflow-y: auto;
      position: relative;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
    }
    
    /* ËôöÊãüÊªöÂä®Âç†‰ΩçÂÖÉÁ¥† */
    .virtual-scroll-placeholder {
      position: relative;
      width: 100%;
    }
    
    /* ÂàÜÈ°µÊéßÂà∂ */
    .pagination-container {
      margin: 20px 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      gap: 5px;
      flex-wrap: wrap;
    }
    
    .pagination-button {
      padding: 6px 12px;
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      cursor: pointer;
      min-width: 40px;
      text-align: center;
      transition: all 0.2s ease;
    }
    
    .pagination-button:hover {
      background-color: #f0f0f0;
      border-color: #bbb;
    }
    
    .pagination-button.active {
      background-color: #007bff;
      color: white;
      border-color: #007bff;
      font-weight: bold;
    }
    
    /* ËÆ¢ÂçïË°®Ê†º‰ºòÂåñ */
    #orders-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    
    #orders-table th {
      position: sticky;
      top: 0;
      background-color: #f8f9fa;
      z-index: 10;
      font-weight: 600;
      padding: 12px 15px;
      text-align: left;
      border-bottom: 2px solid #dee2e6;
    }
    
    #orders-table tbody tr {
      border-bottom: 1px solid #e9ecef;
    }
    
    #orders-table tbody tr:hover {
      background-color: rgba(0,123,255,0.05);
    }
    
    #orders-table td {
      padding: 10px 15px;
      vertical-align: middle;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    /* È°∫Â∫èÂæàÈáçË¶ÅÔºåËøô‰∫õÊ†∑ÂºèÈúÄË¶ÅÊîæÂú®ÂêéÈù¢‰ª•Ë¶ÜÁõñ‰πãÂâçÁöÑÂÆö‰πâ */
    .text-center {
      text-align: center;
    }
    
    .py-4 {
      padding-top: 1.5rem;
      padding-bottom: 1.5rem;
    }
    
    /* Âä†ËΩΩ‰∏≠ÊåáÁ§∫Âô®Ê†∑Âºè */
    .loading-spinner {
      width: 40px;
      height: 40px;
      margin: 20px auto;
      border: 4px solid rgba(0, 123, 255, 0.1);
      border-left-color: #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>
<body>
<div class="navbar">
  <div class="navbar-brand">Á†¥Â§©ÂÖÖÂÄºÁ≥ªÁªü - ÁÆ°ÁêÜÂêéÂè∞</div>
  <div class="navbar-user">
    <div class="user-dropdown">
      <div class="user-info">
        <div class="user-avatar">{{ session.username[0]|upper }}</div>
        <span class="user-name">{{ session.username }}</span>
        <span class="admin-badge">ÁÆ°ÁêÜÂëò</span>
      </div>
      <div class="dropdown-menu">
        <div class="dropdown-menu-header">Ë¥¶Êà∑‰ø°ÊÅØ</div>
        <div class="dropdown-divider"></div>
        <a href="/" class="dropdown-menu-item">
          <i class="fas fa-home"></i>ËøîÂõû‰∏ªÈ°µ
        </a>
        <a href="/logout" class="dropdown-menu-item danger">
          <i class="fas fa-sign-out-alt"></i>ÈÄÄÂá∫ÁôªÂΩï
        </a>
      </div>
    </div>
  </div>
</div>

<div class="main-container">
  <div class="admin-container">
    <div class="sidebar">
      <ul class="sidebar-menu">
        <li><a href="#users" class="active" onclick="showTab('users'); return false;"><i class="fas fa-users"></i> Áî®Êà∑ÁÆ°ÁêÜ</a></li>
        <li><a href="#sellers" onclick="showTab('sellers'); return false;"><i class="fas fa-user-tie"></i> ÂçñÂÆ∂ÁÆ°ÁêÜ</a></li>
      </ul>
    </div>
    
    <div class="content">
      <!-- Áî®Êà∑ÁÆ°ÁêÜ -->
      <div id="users" class="tab-content active">
        <div class="content-header">
          <h2><i class="fas fa-users"></i> Áî®Êà∑ÁÆ°ÁêÜ</h2>
        </div>
        <div class="users-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Áî®Êà∑Âêç</th>
                <th>Ê≥®ÂÜåÊó∂Èó¥</th>
              <th>ÊúÄÂêéÁôªÂΩï</th>
                <th>‰ªäÊó•Ê∂àË¥π</th>
                <th>ËßíËâ≤</th>
              <th>Êìç‰Ωú</th>
            </tr>
          </thead>
          <tbody id="users-table-body">
              <tr>
                <td colspan="7" class="loading">Âä†ËΩΩ‰∏≠...</td>
              </tr>
          </tbody>
        </table>
        </div>
      </div>
      

      
      <!-- ÂçñÂÆ∂ÁÆ°ÁêÜ -->
      <div id="sellers" class="tab-content">
        <div class="content-header">
          <h2><i class="fas fa-user-tie"></i> ÂçñÂÆ∂ÁÆ°ÁêÜ</h2>
          <div class="header-actions">
            <button class="btn btn-primary" onclick="showAddSellerModal()">Ê∑ªÂä†ÂçñÂÆ∂</button>
          </div>
        </div>

        <div class="sellers-container">
          <table class="data-table">
            <thead class="thead-dark">
              <tr>
                <th>ÊòµÁß∞</th>
                <th>Ë¥¶Êà∑Áä∂ÊÄÅ</th>
                <th>ÂàÜÊµÅÁä∂ÊÄÅ</th>
                <th>ËßíËâ≤</th>
                <th>ÂàÜÊµÅÁ≠âÁ∫ß</th>
                <th>ÊúÄÂ§ßÊé•ÂçïÊï∞</th>
                <th>Ê∑ªÂä†Êó∂Èó¥</th>
                <th>Ê∑ªÂä†ËÄÖ</th>
                <th>Êìç‰Ωú</th>
              </tr>
            </thead>
            <tbody id="sellers-table-body">
              <tr>
                <td colspan="7" class="loading">Âä†ËΩΩ‰∏≠...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‰øÆÊîπËÆ¢ÂçïÁºñËæëÊ®°ÊÄÅÊ°Ü -->
<div class="modal-backdrop" id="edit-order-modal">
  <div class="modal">
    <div class="modal-header">
      <h3>ÁºñËæëËÆ¢Âçï</h3>
      <button class="modal-close" data-dismiss="modal">&times;</button>
    </div>
    <div class="modal-body">
      <div id="edit-order-error" class="error-message" style="display:none;"></div>
      <form id="edit-order-form">
        <input type="hidden" id="edit-order-id">
        <div class="form-group">
          <label for="edit-order-account">Ë¥¶Âè∑</label>
          <input type="text" id="edit-order-account" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="edit-order-status">Áä∂ÊÄÅ</label>
          <select id="edit-order-status" class="form-control">
            <option value="submitted">ÂæÖÂ§ÑÁêÜ</option>
            <option value="accepted">Â∑≤Êé•Âçï</option>
            <option value="completed">Â∑≤ÂÆåÊàê</option>
            <option value="failed">ÂÖÖÂÄºÂ§±Ë¥•</option>
            <option value="cancelled">Â∑≤ÂèñÊ∂à</option>
            <option value="disputing">Ê≠£Âú®Ë¥®Áñë</option>
          </select>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-dismiss="modal">ÂèñÊ∂à</button>
      <button class="btn btn-primary" onclick="saveOrderEdit()">‰øùÂ≠ò</button>
    </div>
  </div>
</div>

<!-- Ê∏ÖÁêÜÊóßËÆ¢ÂçïÊ®°ÊÄÅÊ°Ü -->
<div class="modal-backdrop" id="cleanup-orders-modal">
  <div class="modal">
    <div class="modal-header">
      <h3>Ê∏ÖÁêÜÊóßËÆ¢Âçï</h3>
      <button class="modal-close" data-dismiss="modal">&times;</button>
    </div>
    <div class="modal-body">
      <div id="cleanup-orders-error" class="error-message" style="display:none;"></div>
      <form id="cleanup-orders-form">
        <div class="form-group">
          <label for="cleanup-days">‰øùÁïôÊúÄËøëÂá†Â§©ÁöÑËÆ¢ÂçïÔºü</label>
          <input type="number" id="cleanup-days" class="form-control" min="1" value="3" required>
          <small class="text-muted">Â∞ÜÂà†Èô§ÊåáÂÆöÂ§©Êï∞‰πãÂâçÁöÑÊâÄÊúâËÆ¢ÂçïÔºåÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ</small>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-dismiss="modal">ÂèñÊ∂à</button>
      <button class="btn btn-danger" onclick="cleanupOldOrders()">ÊâßË°åÊ∏ÖÁêÜ</button>
    </div>
  </div>
</div>

<!-- Ê∑ªÂä†ÂçñÂÆ∂Ê®°ÊÄÅÊ°Ü -->
<div class="modal-backdrop" id="add-seller-modal">
  <div class="modal">
    <div class="modal-header">
      <h3>Ê∑ªÂä†ÂçñÂÆ∂</h3>
      <button class="modal-close" data-dismiss="modal">&times;</button>
    </div>
    <div class="modal-body">
      <div id="add-seller-error" class="error-message" style="display:none;"></div>
      <form id="add-seller-form">
        <div class="form-group">
          <label for="new-seller-id">Telegram ID <span class="text-danger">*</span></label>
          <input type="number" id="new-seller-id" class="form-control" required>
          <small class="text-muted">ÂøÖÂ°´ÔºåTelegramÁî®Êà∑ÁöÑÊï∞Â≠óID</small>
        </div>
        <div class="form-group">
          <label for="new-seller-username">Áî®Êà∑Âêç</label>
          <input type="text" id="new-seller-username" class="form-control">
          <small class="text-muted">ÈÄâÂ°´ÔºåTelegramÁî®Êà∑ÂêçÔºà‰∏çÂê´@Ôºâ</small>
        </div>
        <div class="form-group">
          <label for="new-seller-firstname">TGÊòµÁß∞</label>
          <input type="text" id="new-seller-firstname" class="form-control">
          <small class="text-muted">ÈÄâÂ°´ÔºåTelegramÊòµÁß∞</small>
        </div>
        <div class="form-group">
          <label for="new-seller-nickname">ÊòæÁ§∫ÊòµÁß∞</label>
          <input type="text" id="new-seller-nickname" class="form-control">
          <small class="text-muted">ÈÄâÂ°´ÔºåÂú®ÁΩëÁ´ô‰∏ãÂçïÈÄâÊã©Êé•Âçï‰∫∫Êó∂ÊòæÁ§∫ÁöÑÊòµÁß∞</small>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-dismiss="modal">ÂèñÊ∂à</button>
      <button class="btn btn-primary" onclick="addSeller()">Ê∑ªÂä†</button>
    </div>
  </div>
</div>

<script>
  // Êõ¥Êñ∞ÂÆöÂà∂‰ª∑Ê†ºÊòæÁ§∫
  function updateCustomPriceDisplay(package, defaultPrices, customPrices) {
    const defaultPrice = defaultPrices[package] || 'Êú™Áü•';
    const customPrice = customPrices[package] || 'ÈªòËÆ§';
    
    document.getElementById('edit-custom-price-default').value = defaultPrice;
    document.getElementById('edit-custom-price-current').value = customPrice === 'ÈªòËÆ§' ? 'ÈªòËÆ§' : customPrice;
    document.getElementById('edit-custom-price-new').value = customPrice === 'ÈªòËÆ§' ? '' : customPrice;
  }

  // Ê†áÁ≠æÈ°µÂàáÊç¢
  function showTab(tabId) {
    // ÈöêËóèÊâÄÊúâÊ†áÁ≠æÈ°µÂÜÖÂÆπ
    document.querySelectorAll('.tab-content').forEach(tab => {
      tab.classList.remove('active');
    });
    
    // ÂèñÊ∂àÊâÄÊúâÂØºËà™È°πÁöÑÊ¥ªÂä®Áä∂ÊÄÅ
    document.querySelectorAll('.sidebar-menu a').forEach(link => {
      link.classList.remove('active');
    });
    
    // ÊòæÁ§∫ÈÄâ‰∏≠ÁöÑÊ†áÁ≠æÈ°µÂÜÖÂÆπ
    const selectedTab = document.getElementById(tabId);
    if (selectedTab) {
      selectedTab.classList.add('active');
    }
    
    // È´ò‰∫ÆÂØºËà™È°π
    const activeLink = document.querySelector(`.sidebar-menu a[href="#${tabId}"]`);
    if (activeLink) {
      activeLink.classList.add('active');
    }
  }
  
  // ÂàùÂßãÂåñÊ†áÁ≠æÈ°µÂàáÊç¢
  function initTabSwitching() {
    document.querySelector('.sidebar-menu a[href="#users"]').addEventListener('click', function() {
      loadUsers();
      showTab('users');
      return false;
    });
    
    document.querySelector('.sidebar-menu a[href="#sellers"]').addEventListener('click', function() {
      loadSellers();
      showTab('sellers');
      return false;
    });
  }
  
  // ÂàùÂßãÂåñÊ®°ÊÄÅÊ°Ü
  function initModals() {
    // ‰∏∫ÊâÄÊúâÂÖ≥Èó≠ÊåâÈíÆÊ∑ªÂä†‰∫ã‰ª∂
    document.querySelectorAll('[data-dismiss="modal"]').forEach(button => {
      button.addEventListener('click', function() {
        const modal = this.closest('.modal-backdrop');
        if (modal) {
          closeModal(modal.id);
        }
      });
    });
  }
  
  // ÊâìÂºÄÊ®°ÊÄÅÊ°Ü
  function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    
    modal.style.display = 'flex';
    setTimeout(() => {
      modal.classList.add('show');
    }, 10);
  }
  
  // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
  function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    
    modal.classList.remove('show');
    setTimeout(() => {
      modal.style.display = 'none';
    }, 300);
  }
  
  // ÊòæÁ§∫Ê∂àÊÅØÊèêÁ§∫
  function showToast(message, type = 'info') {
    // ÂàõÂª∫toastÂÆπÂô®
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
      toastContainer = document.createElement('div');
      toastContainer.id = 'toast-container';
      toastContainer.style.position = 'fixed';
      toastContainer.style.top = '20px';
      toastContainer.style.right = '20px';
      toastContainer.style.zIndex = '9999';
      document.body.appendChild(toastContainer);
    }
    
    // ÂàõÂª∫toastÂÖÉÁ¥†
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.style.minWidth = '250px';
    toast.style.margin = '10px';
    toast.style.padding = '15px';
    toast.style.borderRadius = '4px';
    toast.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
    toast.style.animation = 'fadeIn 0.3s, fadeOut 0.3s 2.7s';
    toast.style.animationFillMode = 'forwards';
    
    // Ê†πÊçÆÁ±ªÂûãËÆæÁΩÆËÉåÊôØËâ≤
    switch(type) {
      case 'success':
        toast.style.backgroundColor = '#4CAF50';
        toast.style.color = 'white';
        break;
      case 'error':
        toast.style.backgroundColor = '#F44336';
        toast.style.color = 'white';
        break;
      case 'warning':
        toast.style.backgroundColor = '#FF9800';
        toast.style.color = 'white';
        break;
      default:
        toast.style.backgroundColor = '#2196F3';
        toast.style.color = 'white';
    }
    
    toast.textContent = message;
    toastContainer.appendChild(toast);
    
    // 3ÁßíÂêéÁßªÈô§
    setTimeout(() => {
      toast.remove();
    }, 3000);
  }

  // ÂºÇÊ≠•Âä†ËΩΩÂçñÂÆ∂Êï∞ÊçÆ
  async function loadSellers() {
    try {
      const tbody = document.getElementById('sellers-table-body');
      if (!tbody) return;
      
      tbody.innerHTML = '<tr><td colspan="8" class="loading">Âä†ËΩΩ‰∏≠...</td></tr>';
      
      const response = await fetch('/admin/api/sellers');
      if (!response.ok) {
        tbody.innerHTML = '<tr><td colspan="8" class="loading">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØï</td></tr>';
        return;
      }
      
      const sellers = await response.json();
      
      tbody.innerHTML = '';
      
      if (sellers.length === 0) {
        const colCount = tbody.parentElement.querySelector('thead tr').childElementCount || 8;
        tbody.innerHTML = `<tr><td colspan="${colCount}" style="text-align:center; padding: 40px;">ÊöÇÊó†ÂçñÂÆ∂</td></tr>`;
        return;
      }
      
      sellers.forEach(seller => {
        const accountStatusBadge = seller.is_active 
          ? '<span class="badge badge-success">Ê≠£Â∏∏</span>' 
          : '<span class="badge badge-secondary">ÂÅúÁî®</span>';
        const toggleButtonText = seller.is_active ? 'ÂÅúÁî®Ë¥¶Êà∑' : 'ÂêØÁî®Ë¥¶Êà∑';
        const toggleButtonClass = seller.is_active ? 'btn-warning' : 'btn-success';
        
        const distributionStatusBadge = seller.participate_in_distribution 
          ? '<span class="badge badge-info">ÂèÇ‰∏éÂàÜÊµÅ</span>' 
          : '<span class="badge badge-warning">ÊöÇÂÅúÂàÜÊµÅ</span>';
        const toggleDistributionButtonText = seller.participate_in_distribution ? 'ÊöÇÂÅúÂàÜÊµÅ' : 'ÊÅ¢Â§çÂàÜÊµÅ';
        const toggleDistributionButtonClass = seller.participate_in_distribution ? 'btn-warning' : 'btn-success';
        
        const adminBadge = seller.is_admin
          ? '<span class="badge badge-primary">ÁÆ°ÁêÜÂëò</span>'
          : '<span class="badge badge-info">ÊôÆÈÄöÂçñÂÆ∂</span>';
        const adminButtonText = seller.is_admin ? 'ÈôçÁ∫ß‰∏∫ÊôÆÈÄöÂçñÂÆ∂' : 'ÂçáÁ∫ß‰∏∫ÁÆ°ÁêÜÂëò';
        const adminButtonClass = seller.is_admin ? 'btn-warning' : 'btn-info';
        
        const row = `
          <tr data-id="${seller.telegram_id}" data-nickname="${escapeHtml(seller.nickname || 'N/A')}">
            <td>${escapeHtml(seller.nickname || '')}</td>
            <td>${accountStatusBadge}</td>
            <td>${distributionStatusBadge}</td>
            <td>${adminBadge}</td>
            <td>
              <input type="number" class="form-control form-control-sm level-input" 
                value="${seller.distribution_level || 1}" 
                min="1" 
                max="10" 
                data-id="${seller.telegram_id}" 
                onchange="updateSellerLevel(${seller.telegram_id}, this.value)">
            </td>
            <td>
              <input type="number" class="form-control form-control-sm max-orders-input" 
                value="${seller.max_concurrent_orders || 5}" 
                min="1" 
                max="20" 
                data-id="${seller.telegram_id}" 
                onchange="updateSellerMaxOrders(${seller.telegram_id}, this.value)">
            </td>
            <td>${seller.added_at}</td>
            <td>${escapeHtml(seller.added_by || '')}</td>
            <td class="actions">
              <button class="btn btn-primary btn-sm" onclick="editSeller(${seller.telegram_id}, '${escapeHtml(seller.nickname || '')}')">ÁºñËæë</button>
              <button class="btn ${toggleDistributionButtonClass} btn-sm" onclick="toggleSellerDistribution(${seller.telegram_id})">${toggleDistributionButtonText}</button>
              <button class="btn ${toggleButtonClass} btn-sm" onclick="toggleSeller(${seller.telegram_id})">${toggleButtonText}</button>
              <button class="btn ${adminButtonClass} btn-sm" onclick="toggleSellerAdmin(${seller.telegram_id})">${adminButtonText}</button>
              <button class="btn btn-danger btn-sm" onclick="removeSeller(${seller.telegram_id})">Âà†Èô§</button>
            </td>
          </tr>
        `;
        tbody.innerHTML += row;
      });
      
      sellerDataLoaded = true;
    } catch (e) {
      console.error('Âä†ËΩΩÂçñÂÆ∂Â§±Ë¥•', e);
      const tbody = document.getElementById('sellers-table-body');
      if (tbody) {
        tbody.innerHTML = '<tr><td colspan="8" class="loading">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØï</td></tr>';
      }
    }
  }
  
  // ÂºÇÊ≠•Âä†ËΩΩÁî®Êà∑Êï∞ÊçÆ
  async function loadUsers() {
    try {
      const tbody = document.getElementById('users-table-body');
      if (!tbody) return;
      
      tbody.innerHTML = '<tr><td colspan="7" class="loading">Âä†ËΩΩ‰∏≠...</td></tr>';
      
      const response = await fetch('/admin/api/users');
      if (!response.ok) {
        tbody.innerHTML = '<tr><td colspan="7" class="loading">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØï</td></tr>';
        return;
      }
      
      const result = await response.json();
      const users = result.users || [];
      
      tbody.innerHTML = '';
      
      if (users.length === 0) {
        const colCount = tbody.parentElement.querySelector('thead tr').childElementCount || 7;
        tbody.innerHTML = `<tr><td colspan="${colCount}" style="text-align:center; padding: 40px;">ÊöÇÊó†Áî®Êà∑</td></tr>`;
        return;
      }
      
      users.forEach(user => {
        const roleBadge = user.is_admin 
          ? '<span class="badge badge-primary">ÁÆ°ÁêÜÂëò</span>' 
          : '<span class="badge badge-info">ÊôÆÈÄöÁî®Êà∑</span>';
        
        const row = `
          <tr data-id="${user.id}">
            <td>${user.id}</td>
            <td>${escapeHtml(user.username)}</td>
            <td>${user.created_at || '-'}</td>
            <td>${user.last_login || '-'}</td>
            <td>${user.today_consumption || '0'}</td>
            <td>${roleBadge}</td>
            <td class="actions">
              <button class="btn btn-primary btn-sm" onclick="editUser(${user.id})">ÁºñËæë</button>
              <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">Âà†Èô§</button>
            </td>
          </tr>
        `;
        tbody.innerHTML += row;
      });
    } catch (e) {
      console.error('Âä†ËΩΩÁî®Êà∑Â§±Ë¥•', e);
      const tbody = document.getElementById('users-table-body');
      if (tbody) {
        tbody.innerHTML = '<tr><td colspan="7" class="loading">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØï</td></tr>';
      }
    }
  }
  
  // HTMLËΩ¨‰πâÂáΩÊï∞
  function escapeHtml(unsafe) {
    if (unsafe === undefined || unsafe === null) return '';
    return String(unsafe)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
  
  // ÁºñËæëÁî®Êà∑
  async function editUser(userId) {
    alert('ÁºñËæëÁî®Êà∑ÂäüËÉΩÂ∞öÊú™ÂÆûÁé∞');
    // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÁºñËæëÁî®Êà∑ÁöÑ‰ª£Á†Å
  }
  
  // Âà†Èô§Áî®Êà∑
  async function deleteUser(userId) {
    if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ID‰∏∫ ${userId} ÁöÑÁî®Êà∑ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`)) {
      return;
    }
    
    try {
      const response = await fetch(`/admin/api/users/${userId}`, {
        method: 'DELETE'
      });
      
      if (response.ok) {
        showToast('Áî®Êà∑Â∑≤ÊàêÂäüÂà†Èô§', 'success');
        loadUsers(); // ÈáçÊñ∞Âä†ËΩΩÁî®Êà∑ÂàóË°®
      } else {
        const result = await response.json();
        showToast(result.error || 'Âà†Èô§Áî®Êà∑Â§±Ë¥•', 'error');
      }
    } catch (e) {
      console.error('Âà†Èô§Áî®Êà∑Â§±Ë¥•', e);
      showToast('ÁΩëÁªúÈîôËØØÔºåÂà†Èô§Â§±Ë¥•', 'error');
    }
  }
  
  // ÂçñÂÆ∂Áõ∏ÂÖ≥Êìç‰ΩúÂáΩÊï∞
  async function editSeller(telegramId, currentNickname) {
    const newNickname = prompt('ËØ∑ËæìÂÖ•Êñ∞ÁöÑÊòæÁ§∫ÊòµÁß∞', currentNickname || '');
    if (newNickname === null) return;
    
    try {
      const response = await fetch(`/admin/api/sellers/${telegramId}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({nickname: newNickname})
      });
      
      if (!response.ok) throw new Error('Êõ¥Êñ∞Â§±Ë¥•');
      
      showToast('ÂçñÂÆ∂ÊòµÁß∞Â∑≤Êõ¥Êñ∞', 'success');
      await loadSellers();
    } catch (e) {
      console.error('Êõ¥Êñ∞ÂçñÂÆ∂ÊòµÁß∞Â§±Ë¥•', e);
      showToast('Êõ¥Êñ∞Â§±Ë¥•: ' + e.message, 'error');
    }
  }
  
  async function toggleSeller(telegramId) {
    await fetch(`/admin/api/sellers/${telegramId}/toggle`, {method: 'POST'});
      loadSellers();
  }

  async function toggleSellerDistribution(telegramId) {
    try {
      const response = await fetch(`/admin/api/sellers/${telegramId}/toggle_distribution`, {method: 'POST'});
      if (response.ok) {
        loadSellers();
        showToast('ÂàÜÊµÅÁä∂ÊÄÅÂ∑≤Êõ¥Êñ∞', 'success');
      } else {
        showToast('Êìç‰ΩúÂ§±Ë¥•', 'error');
      }
    } catch (e) {
      showToast('Êìç‰ΩúÂ§±Ë¥•: ' + e.message, 'error');
    }
  }
  
  async function toggleSellerAdmin(telegramId) {
    if (!confirm('Á°ÆÂÆöË¶ÅÂàáÊç¢Ê≠§ÂçñÂÆ∂ÁöÑÁÆ°ÁêÜÂëòË∫´‰ªΩÂêóÔºü')) return;
    
    try {
      const response = await fetch('/admin/api/sellers/toggle_admin', {
              method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({telegram_id: telegramId})
      });
      
      if (!response.ok) throw new Error('Êìç‰ΩúÂ§±Ë¥•');
      
      await loadSellers();
      showToast('Êìç‰ΩúÊàêÂäü', 'success');
    } catch (e) {
      showToast('Êìç‰ΩúÂ§±Ë¥•: ' + e.message, 'error');
    }
  }
  
  async function removeSeller(telegramId) {
    const sellerRow = document.querySelector(`tr[data-id='${telegramId}']`);
    const nickname = sellerRow ? sellerRow.dataset.nickname : `ID ${telegramId}`;
    
    if (!confirm(`Á°ÆËÆ§Ë¶ÅÂà†Èô§ÂçñÂÆ∂ ${nickname} ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÈÄÜ„ÄÇ`)) return;
    
    await fetch(`/admin/api/sellers/${telegramId}`, {method: 'DELETE'});
    loadSellers();
  }
  
  async function updateSellerLevel(telegramId, newLevel) {
    try {
      const response = await fetch(`/admin/api/sellers/${telegramId}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({distribution_level: parseInt(newLevel)})
      });
      
      if (!response.ok) throw new Error('Êõ¥Êñ∞ÂàÜÊµÅÁ≠âÁ∫ßÂ§±Ë¥•');
      
      showToast('ÂàÜÊµÅÁ≠âÁ∫ßÂ∑≤Êõ¥Êñ∞', 'success');
    } catch (e) {
      showToast('Êõ¥Êñ∞ÂàÜÊµÅÁ≠âÁ∫ßÂ§±Ë¥•: ' + e.message, 'error');
    }
  }

  async function updateSellerMaxOrders(telegramId, newMaxOrders) {
    try {
      const response = await fetch(`/admin/api/sellers/${telegramId}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({max_concurrent_orders: parseInt(newMaxOrders)})
      });
      
      if (!response.ok) throw new Error('Êõ¥Êñ∞ÊúÄÂ§ßÊé•ÂçïÊï∞Â§±Ë¥•');
      
      showToast('ÊúÄÂ§ßÊé•ÂçïÊï∞Â∑≤Êõ¥Êñ∞', 'success');
    } catch (e) {
      showToast('Êõ¥Êñ∞ÊúÄÂ§ßÊé•ÂçïÊï∞Â§±Ë¥•: ' + e.message, 'error');
    }
  }

  async function showAddSellerModal() {
    openModal('add-seller-modal');
  }
  
  async function addSeller() {
    const errorDiv = document.getElementById('add-seller-error');
    const telegramId = document.getElementById('new-seller-id').value;
    
    if (!telegramId) {
      errorDiv.textContent = 'Telegram ID ‰∏çËÉΩ‰∏∫Á©∫„ÄÇ';
      errorDiv.style.display = 'block';
      return;
    }
    
    const data = {
      telegram_id: parseInt(telegramId),
      username: document.getElementById('new-seller-username').value,
      first_name: document.getElementById('new-seller-firstname').value,
      nickname: document.getElementById('new-seller-nickname').value
    };
    
    try {
      const response = await fetch('/admin/api/sellers', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });
      
      if (response.ok) {
        // Ê∏ÖÁ©∫ËæìÂÖ•
        document.getElementById('new-seller-id').value = '';
        document.getElementById('new-seller-username').value = '';
        document.getElementById('new-seller-firstname').value = '';
        document.getElementById('new-seller-nickname').value = '';
        errorDiv.style.display = 'none';
        
        showToast('ÂçñÂÆ∂Ê∑ªÂä†ÊàêÂäüÔºÅ', 'success');
        closeModal('add-seller-modal');
        loadSellers();
      } else {
      const result = await response.json();
        errorDiv.textContent = result.error || 'Ê∑ªÂä†Â§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ';
        errorDiv.style.display = 'block';
      }
    } catch (error) {
      errorDiv.textContent = 'ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï„ÄÇ';
      errorDiv.style.display = 'block';
    }
  }
  
  // Ê∑ªÂä†CSSÂä®Áîª
  const style = document.createElement('style');
  style.textContent = `
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-20px); }
    }
  `;
  document.head.appendChild(style);

  document.addEventListener('DOMContentLoaded', () => {
    // Âä†ËΩΩÁî®Êà∑ÂíåÂçñÂÆ∂Êï∞ÊçÆ
    loadUsers();
    loadSellers();
    
    // ÂàùÂßãÂåñÂêÑÁßç‰∫ã‰ª∂Â§ÑÁêÜ
    initTabSwitching();
    initModals();
    
    // ÊòæÁ§∫ÈªòËÆ§Ê†áÁ≠æÈ°µ
    showTab('users');
  });
</script>
</body>
</html> 