<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>æ²¹ç®¡ä¼šå‘˜å……å€¼ç³»ç»Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- æ·»åŠ Font Awesomeå›¾æ ‡åº“ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Microsoft YaHei', Arial, sans-serif; 
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      margin: 0; padding: 0; min-height: 100vh;
      color: #333;
      font-size: 14px;
      overflow-y: auto;
    }
    
    /* è‡ªå®šä¹‰æç¤ºæ¡†æ ·å¼ */
    .custom-alert {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 9999;
      font-size: 14px;
      display: flex;
      align-items: center;
      min-width: 300px;
      max-width: 80%;
      animation: slideDown 0.3s ease-out;
    }
    
    .custom-alert.success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
    }
    
    .custom-alert.warning {
      background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
      color: #333;
    }
    
    .custom-alert.error {
      background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
      color: white;
    }
    
    .custom-alert-icon {
      margin-right: 10px;
      font-size: 18px;
    }
    
    .custom-alert-close {
      margin-left: auto;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    
    .custom-alert-close:hover {
      opacity: 1;
    }
    
    @keyframes slideDown {
      0% {
        transform: translate(-50%, -20px);
        opacity: 0;
      }
      100% {
        transform: translate(-50%, 0);
        opacity: 1;
      }
    }
    
    .navbar {
      background: rgba(255,255,255,0.9);
      padding: 12px 20px;
      box-shadow: 0 1px 8px rgba(0,0,0,0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    .navbar-brand {
      font-size: 18px;
      font-weight: bold;
      color: #667eea;
      display: flex;
      align-items: center;
    }
    .navbar-brand::before {
      content: 'ğŸ¬';
      margin-right: 6px;
      font-size: 20px;
    }
    .navbar-user {
      display: flex;
      align-items: center;
      gap: 15px;
      position: relative;
    }
    .admin-badge {
      background: linear-gradient(135deg, #ffb347 0%, #ffcc33 100%);
      color: #333;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 2px 5px rgba(255,195,51,0.3);
    }
    .balance-badge {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 2px 5px rgba(56,239,125,0.3);
      display: flex;
      align-items: center;
    }
    .balance-badge.negative {
      background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
    }
    .balance-badge::before {
      content: 'ğŸ’°';
      margin-right: 5px;
    }
    
    /* å……å€¼æŒ‰é’®æ ·å¼ */
    .recharge-btn {
      background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%);
      color: white;
      padding: 3px 8px;
      border-radius: 8px;
      font-size: 10px;
      font-weight: 600;
      margin-left: 8px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(255,94,98,0.3);
      transition: all 0.3s ease;
    }
    .recharge-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(255,94,98,0.4);
    }
    .recharge-btn::before {
      content: 'â•';
      margin-right: 3px;
    }
    
    .btn {
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      font-weight: 600;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .btn:hover { 
      transform: translateY(-3px); 
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    .btn-primary { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      color: white; 
    }
    .btn-danger { 
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5253 100%); 
      color: white; 
    }
    
    .main-container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 0 20px;
    }
    
    .container {
      display: flex;
      gap: 40px;
      align-items: flex-start;
    }

    .left {
      width: 35%;
      flex-shrink: 0;
    }

    .right {
      width: 65%;
    }
    
    .card {
      background: rgba(255,255,255,0.97);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border: 1px solid rgba(255,255,255,0.5);
    }
    
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.18);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .card-header h2 {
      margin: 0;
      font-weight: 600;
      font-size: 18px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .card-header h2::before {
      content: 'ğŸ“';
      margin-right: 8px;
      font-size: 18px;
    }

    .today-total {
      font-size: 14px;
      color: #667eea;
      font-weight: 600;
    }

    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block; 
      margin-bottom: 5px; 
      font-weight: 600; 
      color: #555;
      font-size: 13px;
    }
    
    .form-control {
      width: 100%; 
      padding: 10px 12px; 
      border-radius: 8px;
      border: 2px solid #e1e5e9; 
      font-size: 14px; 
      transition: all 0.3s ease;
      background-color: rgba(255,255,255,0.8);
    }
    
    .form-control:focus {
      outline: none; 
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.2);
      background-color: #fff;
    }
    
    .price-display {
      font-size: 28px;
      font-weight: 700;
      color: #e74c3c;
      margin-top: 5px;
    }
    
    .submit-btn {
      width: 100%; 
      padding: 16px; 
      font-size: 16px; 
      font-weight: 600;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; 
      border: none; 
      border-radius: 10px; 
      cursor: pointer;
      transition: all 0.3s ease; 
      margin-top: 15px;
      box-shadow: 0 5px 15px rgba(102,126,234,0.4);
    }
    
    .submit-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(102,126,234,0.5);
    }
    
    .order-list-container {
      display: grid;
      grid-template-columns: repeat(1, 1fr);
      gap: 15px;
    }

    .order-list-item {
      background: #fff; 
      padding: 16px; 
      margin-bottom: 0;
      border-radius: 10px; 
      border-left: 4px solid #667eea;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
      font-size: 13px;
      position: relative;
      overflow: hidden;
    }
    
    .order-list-item::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
      width: 5px;
      background: linear-gradient(to bottom, transparent, rgba(102,126,234,0.1), transparent);
    }
    
    .order-list-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .order-list-item h4 { 
      margin: 0 0 10px; 
      font-size: 15px; 
      color: #333;
      display: flex;
      align-items: center;
    }
    
    .order-list-item h4::before {
      content: 'ğŸ¬';
      margin-right: 8px;
    }
    
    .order-list-item p { 
      margin: 8px 0; 
      font-size: 15px; 
      color: #666; 
      display: flex;
      align-items: center;
    }
    
    .order-list-item p.account::before {
      content: 'ğŸ‘¤';
      margin-right: 8px;
    }
    
    .order-list-item p.package::before {
      content: 'ğŸ“¦';
      margin-right: 8px;
    }
    
    /* ä»·æ ¼æ ·å¼ */
    .order-list-item p.price {
      margin: 8px 0;
      font-size: 14px;
      color: #e74c3c;
      font-weight: 500;
    }
    
    .order-list-item p.price::before {
      content: 'ğŸ’°';
      margin-right: 8px;
    }
    
    .order-list-item p.status::before {
      content: 'ğŸ”„';
      margin-right: 8px;
    }
  </style>
</head>
<body>
<!-- è‡ªå®šä¹‰æç¤ºæ¡† -->
<div id="customAlert" class="custom-alert" style="display:none">
  <div class="custom-alert-icon">âœ…</div>
  <div class="custom-alert-message">æ“ä½œæˆåŠŸ</div>
  <div class="custom-alert-close" onclick="document.getElementById('customAlert').style.display='none'">Ã—</div>
</div>

<div class="navbar">
  <a href="/" class="navbar-brand">æ²¹ç®¡ä¼šå‘˜å……å€¼</a>
  <div class="navbar-user">
    <a href="/" style="color:#333;text-decoration:none;">å›åˆ°ç ´å¤©å……å€¼</a>
    {% if is_admin %}
    <div class="admin-badge">ç®¡ç†å‘˜</div>
    {% endif %}
    
    <div class="dropdown" style="position: relative;">
      <div style="cursor:pointer;" onclick="document.getElementById('userDropdown').classList.toggle('show')">
        <i class="fas fa-user-circle" style="font-size:18px;margin-right:5px;"></i>
        {{ username }}
        <i class="fas fa-caret-down" style="margin-left:5px;"></i>
      </div>
      
      <div id="userDropdown" class="dropdown-menu" style="display:none;position:absolute;right:0;top:100%;background:white;box-shadow:0 8px 16px rgba(0,0,0,0.1);border-radius:8px;min-width:180px;z-index:1000;">
        {% if is_admin %}
        <a href="/admin" class="dropdown-menu-item">
          <i class="fas fa-cog"></i>ç®¡ç†å‘˜åå°
        </a>
        {% else %}
        <a href="/dashboard" class="dropdown-menu-item">
          <i class="fas fa-user"></i>æˆ‘çš„åå°
        </a>
        {% endif %}
        <a href="/" class="dropdown-menu-item">
          <i class="fas fa-home"></i>è¿”å›é¦–é¡µ
        </a>
        <a href="/logout" class="dropdown-menu-item danger">
          <i class="fas fa-sign-out-alt"></i>é€€å‡ºç™»å½•
        </a>
      </div>
    </div>
    
    {% if balance is defined %}
    <div id="balanceBadge" class="balance-badge {% if balance < 0 %}negative{% endif %}" style="cursor:pointer;">
      ä½™é¢: {{ balance }} å…ƒ
      <a href="/recharge" class="recharge-btn">å……å€¼</a>
    </div>
    {% endif %}
  </div>
</div>

<!-- åˆ·æ–°æŒ‡ç¤ºå™¨ -->
<div id="refreshIndicator">æ­£åœ¨åˆ·æ–°...</div>

<div class="main-container">
    <div class="container">
        <div class="left">
            <div class="card">
                <div class="card-header">
                  <h2>æ²¹ç®¡ä¼šå‘˜å……å€¼</h2>
                </div>
                <form id="orderForm" autocomplete="off">
                  <div class="form-group">
                    <label>æ²¹ç®¡è´¦å·</label>
                    <input name="account" class="form-control" required placeholder="è¯·è¾“å…¥æ‚¨çš„æ²¹ç®¡è´¦å·">
                  </div>
                  <div class="form-group">
                    <label>å¯†ç </label>
                    <input name="password" type="text" class="form-control" required placeholder="è¯·è¾“å…¥å¯†ç ">
                  </div>
                  <div class="form-group">
                    <label>å¥—é¤ç±»å‹</label>
                    <select name="package" class="form-control" id="packageSelect" required>
                      <option value="12">ä¸ªäººä¼šå‘˜ä¸€å¹´</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>ä»·æ ¼</label>
                    <div class="price-display">Â¥<span id="selectedPrice">150</span><small style="margin-left:2px;font-size:12px;font-weight:normal;opacity:0.8;">å…ƒ</small></div>
                  </div>
                  <div class="form-group">
                    <label>å¤‡æ³¨ (å¯é€‰)</label>
                    <input name="remark" class="form-control" placeholder="å¦‚æœ‰ç‰¹æ®Šè¦æ±‚è¯·å¤‡æ³¨">
                  </div>
                  <button type="submit" class="submit-btn">æäº¤è®¢å•</button>
                </form>
            </div>
        </div>

        <div class="right">
            <div class="card">
                <div class="card-header">
                  <h2>{% if session.is_admin %}æ²¹ç®¡è®¢å•çŠ¶æ€{% else %}æˆ‘çš„æ²¹ç®¡è®¢å•{% endif %}</h2>
                  <div class="header-actions">
                    <div class="view-toggle">
                      <button id="gridViewBtn" class="view-btn" title="ç½‘æ ¼è§†å›¾"><i class="fas fa-th"></i></button>
                      <button id="tableViewBtn" class="view-btn active" title="è¡¨æ ¼è§†å›¾"><i class="fas fa-list"></i></button>
                    </div>
                    <div id="today-total" class="today-total"></div>
                  </div>
                </div>
                <div class="search-container">
                  <div class="search-box">
                    <input type="text" id="searchInput" placeholder="æœç´¢è®¢å•å·æˆ–è´¦å·..." class="search-input">
                    <button id="searchBtn" class="search-btn"><i class="fas fa-search"></i></button>
                    <button id="clearSearchBtn" class="clear-search-btn"><i class="fas fa-times"></i></button>
                  </div>
                  <div class="refresh-hint">(æ˜¾ç¤ºå…¨éƒ¨æœ€æ–°è®¢å•ï¼Œæ¯5ç§’è‡ªåŠ¨æ›´æ–°)</div>
                </div>
                <div id="orders-container">åŠ è½½ä¸­...</div>
                <div id="load-more-container" style="text-align:center; margin-top: 20px; display:none;">
                    <button onclick="loadMoreOrders()" class="btn btn-primary">æ˜¾ç¤ºæ›´å¤š</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="balanceInfoBar" style="display:none;padding:8px 15px;background:#fff8e1;border-bottom:1px solid #ffcc33;font-size:13px;text-align:center;">
  å½“å‰ä½™é¢ï¼š{{ balance }} å…ƒ  {% if credit_limit is defined and credit_limit > 0 %}&nbsp;&nbsp;å¯é€æ”¯é¢åº¦ï¼š{{ credit_limit }} å…ƒ{% endif %}
</div>

<script>
  // å…¨å±€å˜é‡
  let displayedOrders = 5; // åˆå§‹æ˜¾ç¤º5ä¸ªè®¢å•
  let allOrders = []; // å­˜å‚¨æ‰€æœ‰è®¢å•
  let searchKeyword = ''; // æœç´¢å…³é”®è¯
  let autoRefreshInterval = null;
  let userId = '{{ session.user_id }}'; // å½“å‰ç”¨æˆ·ID
  let isAdmin = {{ 'true' if session.is_admin else 'false' }}; // æ˜¯å¦æ˜¯ç®¡ç†å‘˜
  let lastOrdersHash = ''; // ç”¨äºæ£€æµ‹è®¢å•å˜åŒ–çš„å“ˆå¸Œ
  let viewMode = 'grid'; // é»˜è®¤è§†å›¾æ¨¡å¼ï¼šgrid æˆ– table
  
  // æ²¹ç®¡ä¼šå‘˜ä»·æ ¼
  const YOUTUBE_PRICES = {'12': 150};
  
  // ç”¨æˆ·å®é™…ä»·æ ¼
  let USER_PRICES = {...YOUTUBE_PRICES};
  
  // æ›´æ–°ä»·æ ¼æ˜¾ç¤º
  function updatePriceDisplay() {
    const packageSelect = document.getElementById('packageSelect');
    const selectedPrice = document.getElementById('selectedPrice');
    
    if (packageSelect && selectedPrice) {
      // æ˜¾ç¤ºå½“å‰é€‰ä¸­å¥—é¤çš„ä»·æ ¼
      selectedPrice.textContent = USER_PRICES[packageSelect.value];
    }
  }
  
  // é¡µé¢åŠ è½½å¤„ç†
  document.addEventListener('DOMContentLoaded', function() {
    // æœç´¢åŠŸèƒ½åˆå§‹åŒ–
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    
    // æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    searchBtn.addEventListener('click', function() {
      searchKeyword = searchInput.value.trim();
      displayedOrders = 5; // é‡ç½®æ˜¾ç¤ºæ•°é‡
      
      if (searchKeyword) {
        const filteredOrders = allOrders.filter(order => 
          order.id.toString().includes(searchKeyword) || 
          order.account.toLowerCase().includes(searchKeyword.toLowerCase())
        );
        renderOrders(filteredOrders);
      } else {
        renderOrders(allOrders);
      }
    });
    
    // å›è½¦é”®æœç´¢
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        searchBtn.click();
      }
    });
    
    // æ¸…é™¤æœç´¢
    clearSearchBtn.addEventListener('click', function() {
      searchInput.value = '';
      searchKeyword = '';
      displayedOrders = 5;
      renderOrders(allOrders);
    });

    // åŠ è½½è®¢å•
    loadOrders();
    
    // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
    startAutoRefresh();
    
    // åˆ‡æ¢è§†å›¾æ¨¡å¼
    const gridViewBtn = document.getElementById('gridViewBtn');
    const tableViewBtn = document.getElementById('tableViewBtn');
    
    gridViewBtn.addEventListener('click', function() {
      viewMode = 'grid';
      gridViewBtn.classList.add('active');
      tableViewBtn.classList.remove('active');
      renderOrders(allOrders);
    });
    
    tableViewBtn.addEventListener('click', function() {
      viewMode = 'table';
      tableViewBtn.classList.add('active');
      gridViewBtn.classList.remove('active');
      renderOrders(allOrders);
    });
    
    // æäº¤è®¢å•
    const orderForm = document.getElementById('orderForm');
    
    orderForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(orderForm);
      
      // ç¦ç”¨è¡¨å•å…ƒç´ 
      const submitBtn = this.querySelector('button[type="submit"]');
      const formElements = this.querySelectorAll('input, select, button');
      formElements.forEach(el => el.disabled = true);
      submitBtn.textContent = 'æäº¤ä¸­...';
      
      // æäº¤è¯·æ±‚
      fetch('/youtube', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        // é‡æ–°å¯ç”¨è¡¨å•å…ƒç´ 
        formElements.forEach(el => el.disabled = false);
        submitBtn.textContent = 'æäº¤è®¢å•';
        
        if (data.success) {
          // è®¢å•æäº¤æˆåŠŸ
          showCustomAlert(data.message, 'success');
          orderForm.reset();
          
          // åˆ·æ–°è®¢å•åˆ—è¡¨
          loadOrders(false);
          
          // æ›´æ–°ä½™é¢æ˜¾ç¤º
          if (data.balance !== undefined) {
            updateBalanceDisplay(data.balance, data.credit_limit);
          }
        } else {
          // è®¢å•æäº¤å¤±è´¥
          showCustomAlert(data.error, 'error');
          
          // æ›´æ–°ä½™é¢æ˜¾ç¤ºï¼ˆå¦‚æœAPIè¿”å›äº†ä½™é¢ä¿¡æ¯ï¼‰
          if (data.balance !== undefined) {
            updateBalanceDisplay(data.balance, data.credit_limit);
          }
        }
      })
      .catch(error => {
        console.error('æäº¤è®¢å•æ—¶å‡ºé”™:', error);
        showCustomAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
        
        // é‡æ–°å¯ç”¨è¡¨å•å…ƒç´ 
        formElements.forEach(el => el.disabled = false);
        submitBtn.textContent = 'æäº¤è®¢å•';
      });
    });
    
    // åœ¨Safariä¸­ä¹Ÿæ˜¾ç¤ºä¸‹æ‹‰èœå•
    document.addEventListener('click', function(e) {
      const dropdown = document.getElementById('userDropdown');
      if (!e.target.closest('.dropdown') && dropdown.classList.contains('show')) {
        dropdown.classList.remove('show');
      }
    });
  });
  
  // åŠ è½½è®¢å•
  async function loadOrders(silent = true) {
    try {
      // æ˜¾ç¤ºåˆ·æ–°æŒ‡ç¤ºå™¨
      const refreshIndicator = document.getElementById('refreshIndicator');
      if (!silent) {
        refreshIndicator.classList.add('show');
      }
      
      // è·å–æ²¹ç®¡ä¼šå‘˜è®¢å•
      const response = await fetch('/api/orders?product_type=youtube');
      
      if (!response.ok) {
        console.error('è·å–è®¢å•å¤±è´¥', response.status);
        if (!silent) refreshIndicator.classList.remove('show');
        return;
      }
      
      const data = await response.json();
      
      if (data.success) {
        // æ£€æŸ¥è®¢å•æ˜¯å¦æœ‰å˜åŒ–
        const newOrdersHash = JSON.stringify(data.orders);
        if (newOrdersHash === lastOrdersHash) {
          if (!silent) refreshIndicator.classList.remove('show');
          return;
        }
        
        lastOrdersHash = newOrdersHash;
        allOrders = data.orders;
        
        renderOrders(allOrders);
        
        // æ›´æ–°ä»Šæ—¥è®¢å•æ€»é‡
        if (data.today_total) {
          document.getElementById('today-total').textContent = `ä»Šæ—¥è®¢å•: ${data.today_total}`;
        }
      }
      
      if (!silent) {
        setTimeout(() => {
          refreshIndicator.classList.remove('show');
        }, 500);
      }
    } catch (error) {
      console.error('è·å–è®¢å•åˆ—è¡¨å¤±è´¥:', error);
      if (!silent) {
        document.getElementById('refreshIndicator').classList.remove('show');
      }
    }
  }
  
  // æ¸²æŸ“è®¢å•åˆ—è¡¨
  function renderOrders(orders) {
    const ordersContainer = document.getElementById('orders-container');
    const loadMoreContainer = document.getElementById('load-more-container');
    
    if (!orders || orders.length === 0) {
      ordersContainer.innerHTML = '<div class="no-orders">æš‚æ— æ²¹ç®¡ä¼šå‘˜å……å€¼è®¢å•</div>';
      loadMoreContainer.style.display = 'none';
      return;
    }
    
    // æ˜¾ç¤ºé™å®šæ•°é‡çš„è®¢å•
    const ordersToDisplay = orders.slice(0, displayedOrders);
    
    if (viewMode === 'grid') {
      // ç½‘æ ¼è§†å›¾
      ordersContainer.innerHTML = '<div class="order-list-container">' +
        ordersToDisplay.map(order => createOrderGridItem(order)).join('') +
        '</div>';
    } else {
      // è¡¨æ ¼è§†å›¾
      ordersContainer.innerHTML = createOrderTable(ordersToDisplay);
    }
    
    // æ˜¯å¦æ˜¾ç¤º"æ˜¾ç¤ºæ›´å¤š"æŒ‰é’®
    loadMoreContainer.style.display = orders.length > displayedOrders ? 'block' : 'none';
  }
  
  // åˆ›å»ºè®¢å•ç½‘æ ¼é¡¹
  function createOrderGridItem(order) {
    const canCancel = order.status === 'submitted' && (isAdmin || order.creator === userId);
    
    let orderItem = `
      <div class="order-list-item">
        <h4>è®¢å• #${order.id}</h4>
        <p class="account">è´¦å·ï¼š${order.account}</p>
        <p class="package">å¥—é¤ï¼šä¸ªäººä¼šå‘˜ä¸€å¹´</p>
        <p class="status">çŠ¶æ€ï¼š<span class="status-badge status-${order.status}">${order.status_text || order.status}</span></p>
        <div class="time-info">
          <p class="time">åˆ›å»ºæ—¶é—´ï¼š${order.created_at}</p>
          ${order.accepted_at ? `<p class="time">æ¥å•æ—¶é—´ï¼š${order.accepted_at}</p>` : ''}
          ${order.completed_at ? `<p class="time">å®Œæˆæ—¶é—´ï¼š${order.completed_at}</p>` : ''}
          ${order.accepted_at && !order.completed_at && order.status === 'accepted' ? 
            `<div style="margin:10px 0"><button onclick="urgeOrder(${order.id})" class="btn btn-primary btn-sm">å‚¬å•</button></div>` : ''}
        </div>
        ${order.fail_reason ? `<p class="reason">${order.fail_reason}</p>` : ''}
        ${canCancel ? 
          `<div style="margin:10px 0"><button onclick="cancelOrder(${order.id}, this)" class="btn btn-danger btn-sm">æ’¤é”€è®¢å•</button></div>` : ''}
      </div>
    `;
    
    return orderItem;
  }
  
  // åˆ›å»ºè®¢å•è¡¨æ ¼
  function createOrderTable(orders) {
    return `
      <table class="orders-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>è´¦å·</th>
            <th>å¥—é¤</th>
            <th>çŠ¶æ€</th>
            <th>åˆ›å»ºæ—¶é—´</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          ${orders.map(order => {
            const canCancel = order.status === 'submitted' && (isAdmin || order.creator === userId);
            return `
              <tr>
                <td>#${order.id}</td>
                <td>${order.account}</td>
                <td>ä¸ªäººä¼šå‘˜ä¸€å¹´</td>
                <td><span class="status-badge status-${order.status}">${order.status_text || order.status}</span></td>
                <td>${order.created_at}</td>
                <td>
                  ${order.accepted_at && !order.completed_at && order.status === 'accepted' ? 
                    `<button onclick="urgeOrder(${order.id})" class="btn btn-primary btn-sm">å‚¬å•</button>` : ''}
                  ${canCancel ? 
                    `<button onclick="cancelOrder(${order.id}, this)" class="btn btn-danger btn-sm">æ’¤é”€</button>` : ''}
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    `;
  }
  
  // åŠ è½½æ›´å¤šè®¢å•
  function loadMoreOrders() {
    displayedOrders += 5;
    renderOrders(allOrders);
  }
  
  // æ›´æ–°ä½™é¢æ˜¾ç¤º
  function updateBalanceDisplay(balance, creditLimit) {
    const balanceBadge = document.getElementById('balanceBadge');
    
    if (balanceBadge) {
      // æ›´æ–°é¡¶éƒ¨ä½™é¢å¾½ç« 
      balanceBadge.className = 'balance-badge' + (balance < 0 ? ' negative' : '');
      balanceBadge.innerHTML = `ä½™é¢: ${balance} å…ƒ<a href="/recharge" class="recharge-btn">å……å€¼</a>`;
      
      // æ›´æ–°åº•éƒ¨ä¿¡æ¯æ 
      const balanceInfoBar = document.getElementById('balanceInfoBar');
      if (balanceInfoBar) {
        balanceInfoBar.style.display = 'block';
        balanceInfoBar.innerHTML = `å½“å‰ä½™é¢ï¼š${balance} å…ƒ` + (creditLimit > 0 ? ` &nbsp;&nbsp;å¯é€æ”¯é¢åº¦ï¼š${creditLimit} å…ƒ` : '');
      }
    }
  }
  
  // å‚¬å•ï¼ˆå½“è®¢å•æ¥å•è¶…è¿‡20åˆ†é’Ÿæœªå®Œæˆæ—¶ï¼‰
  async function urgeOrder(orderId) {
    if (!confirm('æ‚¨ç¡®å®šè¦å‚¬ä¿ƒæ­¤è®¢å•å—ï¼Ÿè¿™å°†å‘å–å®¶å‘é€å‚¬å•é€šçŸ¥ã€‚')) return;
    
    try {
      const resp = await fetch(`/orders/urge/${orderId}`, { method: 'POST' });
      const result = await resp.json();
      
      if (result.success) {
        showCustomAlert('å‚¬å•é€šçŸ¥å·²å‘é€ç»™å–å®¶', 'success');
      } else {
        alert(result.error || 'å‚¬å•å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    } catch (e) {
      console.error('å‚¬å•å¤±è´¥', e);
      alert('å‚¬å•å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }
  
  // æ’¤é”€è®¢å•
  async function cancelOrder(id, buttonElement) {
    if (!confirm('ç¡®å®šè¦æ’¤é”€æ­¤è®¢å•å—ï¼Ÿ')) return;
    
    // ç¦ç”¨æŒ‰é’®
    buttonElement.disabled = true;
    buttonElement.textContent = 'æ’¤é”€ä¸­...';
    
    try {
      const resp = await fetch('/orders/cancel/' + id, { method: 'POST' });
      if (resp.ok) {
        // ç«‹å³æ›´æ–°æ˜¾ç¤º
        await loadOrders(false);
        showCustomAlert('è®¢å•å·²æ’¤é”€', 'success');
      } else {
        showCustomAlert('æ’¤é”€å¤±è´¥', 'error');
        buttonElement.disabled = false;
        buttonElement.textContent = 'æ’¤é”€è®¢å•';
      }
    } catch (e) {
      showCustomAlert('æ’¤é”€å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      buttonElement.disabled = false;
      buttonElement.textContent = 'æ’¤é”€è®¢å•';
    }
  }
  
  // è‡ªåŠ¨åˆ·æ–°ç®¡ç†
  function startAutoRefresh() {
    stopAutoRefresh(); // å…ˆåœæ­¢ç°æœ‰çš„
    autoRefreshInterval = setInterval(() => {
      // å¦‚æœæ²¡æœ‰æœç´¢å…³é”®è¯ï¼Œåˆ™è‡ªåŠ¨åˆ·æ–°
      if (!searchKeyword) {
        loadOrders(true);
      }
    }, 5000);
  }
  
  function stopAutoRefresh() {
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
      autoRefreshInterval = null;
    }
  }
  
  // è‡ªå®šä¹‰æç¤ºæ¡†
  function showCustomAlert(message, type = 'success') {
    const alert = document.getElementById('customAlert');
    const icon = alert.querySelector('.custom-alert-icon');
    const messageEl = alert.querySelector('.custom-alert-message');
    
    alert.className = 'custom-alert';
    alert.classList.add(type);
    
    if (type === 'success') {
      icon.innerHTML = 'âœ…';
    } else if (type === 'error') {
      icon.innerHTML = 'âŒ';
    } else if (type === 'warning') {
      icon.innerHTML = 'âš ï¸';
    }
    
    messageEl.textContent = message;
    alert.style.display = 'flex';
    
    // 5ç§’åè‡ªåŠ¨éšè—
    setTimeout(hideCustomAlert, 5000);
  }
  
  function hideCustomAlert() {
    document.getElementById('customAlert').style.display = 'none';
  }
</script>
</body>
</html> 