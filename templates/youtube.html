<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Ê≤πÁÆ°‰ºöÂëòÂÖÖÂÄºÁ≥ªÁªü</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Ê∑ªÂä†Font AwesomeÂõæÊ†áÂ∫ì -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: 'Microsoft YaHei', Arial, sans-serif; 
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      margin: 0; padding: 0; min-height: 100vh;
      color: #333;
      font-size: 14px;
      overflow-y: auto;
    }
    
    /* Ëá™ÂÆö‰πâÊèêÁ§∫Ê°ÜÊ†∑Âºè */
    .custom-alert {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 9999;
      font-size: 14px;
      display: flex;
      align-items: center;
      min-width: 300px;
      max-width: 80%;
      animation: slideDown 0.3s ease-out;
    }
    
    .custom-alert.success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
    }
    
    .custom-alert.warning {
      background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
      color: #333;
    }
    
    .custom-alert.error {
      background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
      color: white;
    }
    
    .custom-alert-icon {
      margin-right: 10px;
      font-size: 18px;
    }
    
    .custom-alert-close {
      margin-left: auto;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    
    .custom-alert-close:hover {
      opacity: 1;
    }
    
    @keyframes slideDown {
      0% {
        transform: translate(-50%, -20px);
        opacity: 0;
      }
      100% {
        transform: translate(-50%, 0);
        opacity: 1;
      }
    }
    
    .navbar {
      background: rgba(255,255,255,0.9);
      padding: 12px 20px;
      box-shadow: 0 1px 8px rgba(0,0,0,0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    .navbar-brand {
      font-size: 18px;
      font-weight: bold;
      color: #667eea;
      display: flex;
      align-items: center;
    }
    .navbar-brand::before {
      content: 'üé¨';
      margin-right: 6px;
      font-size: 20px;
    }
    .navbar-user {
      display: flex;
      align-items: center;
      gap: 15px;
      position: relative;
    }
    .admin-badge {
      background: linear-gradient(135deg, #ffb347 0%, #ffcc33 100%);
      color: #333;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 2px 5px rgba(255,195,51,0.3);
    }
    .balance-badge {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 2px 5px rgba(56,239,125,0.3);
      display: flex;
      align-items: center;
    }
    .balance-badge.negative {
      background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
    }
    .balance-badge::before {
      content: 'üí∞';
      margin-right: 5px;
    }
    
    /* ÂÖÖÂÄºÊåâÈíÆÊ†∑Âºè */
    .recharge-btn {
      background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%);
      color: white;
      padding: 3px 8px;
      border-radius: 8px;
      font-size: 10px;
      font-weight: 600;
      margin-left: 8px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(255,94,98,0.3);
      transition: all 0.3s ease;
    }
    .recharge-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(255,94,98,0.4);
    }
    .recharge-btn::before {
      content: '‚ûï';
      margin-right: 3px;
    }
    
    .btn {
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      font-weight: 600;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .btn:hover { 
      transform: translateY(-3px); 
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    .btn-primary { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      color: white; 
    }
    .btn-danger { 
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5253 100%); 
      color: white; 
    }
    
    .main-container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 0 20px;
    }
    
    .container {
      display: flex;
      gap: 40px;
      align-items: flex-start;
    }

    .left {
      width: 35%;
      flex-shrink: 0;
    }

    .right {
      width: 65%;
    }
    
    .card {
      background: rgba(255,255,255,0.97);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border: 1px solid rgba(255,255,255,0.5);
    }
    
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.18);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .card-header h2 {
      margin: 0;
      font-weight: 600;
      font-size: 18px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .card-header h2::before {
      content: 'üìù';
      margin-right: 8px;
      font-size: 18px;
    }

    .today-total {
      font-size: 14px;
      color: #667eea;
      font-weight: 600;
    }

    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block; 
      margin-bottom: 5px; 
      font-weight: 600; 
      color: #555;
      font-size: 13px;
    }
    
    .form-control {
      width: 100%; 
      padding: 10px 12px; 
      border-radius: 8px;
      border: 2px solid #e1e5e9; 
      font-size: 14px; 
      transition: all 0.3s ease;
      background-color: rgba(255,255,255,0.8);
    }
    
    .form-control:focus {
      outline: none; 
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.2);
      background-color: #fff;
    }
    
    .price-display {
      font-size: 28px;
      font-weight: 700;
      color: #e74c3c;
      margin-top: 5px;
    }
    
    .submit-btn {
      width: 100%; 
      padding: 16px; 
      font-size: 16px; 
      font-weight: 600;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; 
      border: none; 
      border-radius: 10px; 
      cursor: pointer;
      transition: all 0.3s ease; 
      margin-top: 15px;
      box-shadow: 0 5px 15px rgba(102,126,234,0.4);
    }
    
    .submit-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(102,126,234,0.5);
    }
    
    .order-list-container {
      display: grid;
      grid-template-columns: repeat(1, 1fr);
      gap: 15px;
    }

    .order-list-item {
      background: #fff; 
      padding: 16px; 
      margin-bottom: 0;
      border-radius: 10px; 
      border-left: 4px solid #667eea;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
      font-size: 13px;
      position: relative;
      overflow: hidden;
    }
    
    .order-list-item::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
      width: 5px;
      background: linear-gradient(to bottom, transparent, rgba(102,126,234,0.1), transparent);
    }
    
    .order-list-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .order-list-item h4 { 
      margin: 0 0 10px; 
      font-size: 15px; 
      color: #333;
      display: flex;
      align-items: center;
    }
    
    .order-list-item h4::before {
      content: 'üé¨';
      margin-right: 8px;
    }
    
    .order-list-item p { 
      margin: 8px 0; 
      font-size: 15px; 
      color: #666; 
      display: flex;
      align-items: center;
    }
    
    .order-list-item p.account::before {
      content: 'üë§';
      margin-right: 8px;
    }
    
    .order-list-item p.package::before {
      content: 'üì¶';
      margin-right: 8px;
    }
    
    /* ‰ª∑Ê†ºÊ†∑Âºè */
    .order-list-item p.price {
      margin: 8px 0;
      font-size: 14px;
      color: #e74c3c;
      font-weight: 500;
    }
    
    .order-list-item p.price::before {
      content: 'üí∞';
      margin-right: 8px;
    }
    
    .order-list-item p.status::before {
      content: 'üîÑ';
      margin-right: 8px;
    }
  </style>
</head>
<body>
<!-- Ëá™ÂÆö‰πâÊèêÁ§∫Ê°Ü -->
<div id="customAlert" class="custom-alert" style="display:none">
  <div class="custom-alert-icon">‚úÖ</div>
  <div class="custom-alert-message">Êìç‰ΩúÊàêÂäü</div>
  <div class="custom-alert-close" onclick="document.getElementById('customAlert').style.display='none'">√ó</div>
</div>

<div class="navbar">
  <a href="/" class="navbar-brand">Ê≤πÁÆ°‰ºöÂëòÂÖÖÂÄº</a>
  <div class="navbar-user">
    <a href="/" style="color:#333;text-decoration:none;">ÂõûÂà∞Á†¥Â§©ÂÖÖÂÄº</a>
    {% if is_admin %}
    <div class="admin-badge">ÁÆ°ÁêÜÂëò</div>
    {% endif %}
    
    <div class="dropdown" style="position: relative;">
      <div style="cursor:pointer;" onclick="document.getElementById('userDropdown').classList.toggle('show')">
        <i class="fas fa-user-circle" style="font-size:18px;margin-right:5px;"></i>
        {{ username }}
        <i class="fas fa-caret-down" style="margin-left:5px;"></i>
      </div>
      
      <div id="userDropdown" class="dropdown-menu" style="display:none;position:absolute;right:0;top:100%;background:white;box-shadow:0 8px 16px rgba(0,0,0,0.1);border-radius:8px;min-width:180px;z-index:1000;">
        {% if is_admin %}
        <a href="/admin" class="dropdown-menu-item">
          <i class="fas fa-cog"></i>ÁÆ°ÁêÜÂëòÂêéÂè∞
        </a>
        {% else %}
        <a href="/dashboard" class="dropdown-menu-item">
          <i class="fas fa-user"></i>ÊàëÁöÑÂêéÂè∞
        </a>
        {% endif %}
        <a href="/" class="dropdown-menu-item">
          <i class="fas fa-home"></i>ËøîÂõûÈ¶ñÈ°µ
        </a>
        <a href="/logout" class="dropdown-menu-item danger">
          <i class="fas fa-sign-out-alt"></i>ÈÄÄÂá∫ÁôªÂΩï
        </a>
      </div>
    </div>
    
    {% if balance is defined %}
    <div id="balanceBadge" class="balance-badge {% if balance < 0 %}negative{% endif %}" style="cursor:pointer;">
      ‰ΩôÈ¢ù: {{ balance }} ÂÖÉ
      <a href="/recharge" class="recharge-btn">ÂÖÖÂÄº</a>
    </div>
    {% endif %}
  </div>
</div>

<!-- Âà∑Êñ∞ÊåáÁ§∫Âô® -->
<div id="refreshIndicator">Ê≠£Âú®Âà∑Êñ∞...</div>

<div class="main-container">
    <div class="container">
        <div class="left">
            <div class="card">
                <div class="card-header">
                  <h2>Ê≤πÁÆ°‰ºöÂëòÂÖÖÂÄº</h2>
                </div>
                <form id="orderForm" autocomplete="off">
                  <div class="form-group">
                    <label>Ê≤πÁÆ°Ë¥¶Âè∑</label>
                    <input name="account" class="form-control" required placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÊ≤πÁÆ°Ë¥¶Âè∑">
                  </div>
                  <div class="form-group">
                    <label>ÂØÜÁ†Å</label>
                    <input name="password" type="text" class="form-control" required placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å">
                  </div>
                  <div class="form-group">
                    <label>Â•óÈ§êÁ±ªÂûã</label>
                    <select name="package" class="form-control" id="packageSelect" required>
                      <option value="12">‰∏™‰∫∫‰ºöÂëò‰∏ÄÂπ¥</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>‰ª∑Ê†º</label>
                    <div class="price-display">¬•<span id="selectedPrice">150</span><small style="margin-left:2px;font-size:12px;font-weight:normal;opacity:0.8;">ÂÖÉ</small></div>
                  </div>
                  <div class="form-group">
                    <label>Â§áÊ≥® (ÂèØÈÄâ)</label>
                    <input name="remark" class="form-control" placeholder="Â¶ÇÊúâÁâπÊÆäË¶ÅÊ±ÇËØ∑Â§áÊ≥®">
                  </div>
                  <button type="submit" class="submit-btn">Êèê‰∫§ËÆ¢Âçï</button>
                </form>
            </div>
        </div>

        <div class="right">
            <div class="card">
                <div class="card-header">
                  <h2>{% if session.is_admin %}Ê≤πÁÆ°ËÆ¢ÂçïÁä∂ÊÄÅ{% else %}ÊàëÁöÑÊ≤πÁÆ°ËÆ¢Âçï{% endif %}</h2>
                  <div class="header-actions">
                    <div class="view-toggle">
                      <button id="gridViewBtn" class="view-btn" title="ÁΩëÊ†ºËßÜÂõæ"><i class="fas fa-th"></i></button>
                      <button id="tableViewBtn" class="view-btn active" title="Ë°®Ê†ºËßÜÂõæ"><i class="fas fa-list"></i></button>
                    </div>
                    <div id="today-total" class="today-total"></div>
                  </div>
                </div>
                <div class="search-container">
                  <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ÊêúÁ¥¢ËÆ¢ÂçïÂè∑ÊàñË¥¶Âè∑..." class="search-input">
                    <button id="searchBtn" class="search-btn"><i class="fas fa-search"></i></button>
                    <button id="clearSearchBtn" class="clear-search-btn"><i class="fas fa-times"></i></button>
                  </div>
                  <div class="refresh-hint">(ÊòæÁ§∫ÂÖ®ÈÉ®ÊúÄÊñ∞ËÆ¢ÂçïÔºåÊØè5ÁßíËá™Âä®Êõ¥Êñ∞)</div>
                </div>
                <div id="orders-container">Âä†ËΩΩ‰∏≠...</div>
                <div id="load-more-container" style="text-align:center; margin-top: 20px; display:none;">
                    <button onclick="loadMoreOrders()" class="btn btn-primary">ÊòæÁ§∫Êõ¥Â§ö</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="balanceInfoBar" style="display:none;padding:8px 15px;background:#fff8e1;border-bottom:1px solid #ffcc33;font-size:13px;text-align:center;">
  ÂΩìÂâç‰ΩôÈ¢ùÔºö{{ balance }} ÂÖÉ  {% if credit_limit is defined and credit_limit > 0 %}&nbsp;&nbsp;ÂèØÈÄèÊîØÈ¢ùÂ∫¶Ôºö{{ credit_limit }} ÂÖÉ{% endif %}
</div>

<script>
  // ÂÖ®Â±ÄÂèòÈáè
  let displayedOrders = 5; // ÂàùÂßãÊòæÁ§∫5‰∏™ËÆ¢Âçï
  let allOrders = []; // Â≠òÂÇ®ÊâÄÊúâËÆ¢Âçï
  let searchKeyword = ''; // ÊêúÁ¥¢ÂÖ≥ÈîÆËØç
  let autoRefreshInterval = null;
  let userId = '{{ session.user_id }}'; // ÂΩìÂâçÁî®Êà∑ID
  let isAdmin = {{ 'true' if session.is_admin else 'false' }}; // ÊòØÂê¶ÊòØÁÆ°ÁêÜÂëò
  let lastOrdersHash = ''; // Áî®‰∫éÊ£ÄÊµãËÆ¢ÂçïÂèòÂåñÁöÑÂìàÂ∏å
  let viewMode = 'grid'; // ÈªòËÆ§ËßÜÂõæÊ®°ÂºèÔºögrid Êàñ table
  
  // Ê≤πÁÆ°‰ºöÂëò‰ª∑Ê†º
  const YOUTUBE_PRICES = {'12': 150};
  
  // Áî®Êà∑ÂÆûÈôÖ‰ª∑Ê†º
  let USER_PRICES = {...YOUTUBE_PRICES};
  
  // Êõ¥Êñ∞‰ª∑Ê†ºÊòæÁ§∫
  function updatePriceDisplay() {
    const packageSelect = document.getElementById('packageSelect');
    const selectedPrice = document.getElementById('selectedPrice');
    
    if (packageSelect && selectedPrice) {
      // ÊòæÁ§∫ÂΩìÂâçÈÄâ‰∏≠Â•óÈ§êÁöÑ‰ª∑Ê†º
      selectedPrice.textContent = USER_PRICES[packageSelect.value];
    }
  }
  
  // È°µÈù¢Âä†ËΩΩÂ§ÑÁêÜ
  document.addEventListener('DOMContentLoaded', function() {
    // ÊêúÁ¥¢ÂäüËÉΩÂàùÂßãÂåñ
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    
    // ÊêúÁ¥¢ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
    searchBtn.addEventListener('click', function() {
      searchKeyword = searchInput.value.trim();
      displayedOrders = 5; // ÈáçÁΩÆÊòæÁ§∫Êï∞Èáè
      
      if (searchKeyword) {
        const filteredOrders = allOrders.filter(order => 
          order.id.toString().includes(searchKeyword) || 
          order.account.toLowerCase().includes(searchKeyword.toLowerCase())
        );
        renderOrders(filteredOrders);
      } else {
        renderOrders(allOrders);
      }
    });
    
    // ÂõûËΩ¶ÈîÆÊêúÁ¥¢
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        searchBtn.click();
      }
    });
    
    // Ê∏ÖÈô§ÊêúÁ¥¢
    clearSearchBtn.addEventListener('click', function() {
      searchInput.value = '';
      searchKeyword = '';
      displayedOrders = 5;
      renderOrders(allOrders);
    });

    // Âä†ËΩΩËÆ¢Âçï
    loadOrders();
    
    // ÂêØÂä®Ëá™Âä®Âà∑Êñ∞
    startAutoRefresh();
    
    // ÂàáÊç¢ËßÜÂõæÊ®°Âºè
    const gridViewBtn = document.getElementById('gridViewBtn');
    const tableViewBtn = document.getElementById('tableViewBtn');
    
    gridViewBtn.addEventListener('click', function() {
      viewMode = 'grid';
      gridViewBtn.classList.add('active');
      tableViewBtn.classList.remove('active');
      renderOrders(allOrders);
    });
    
    tableViewBtn.addEventListener('click', function() {
      viewMode = 'table';
      tableViewBtn.classList.add('active');
      gridViewBtn.classList.remove('active');
      renderOrders(allOrders);
    });
    
    // Êèê‰∫§ËÆ¢Âçï
    const orderForm = document.getElementById('orderForm');
    
    orderForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(orderForm);
      
      // Á¶ÅÁî®Ë°®ÂçïÂÖÉÁ¥†
      const submitBtn = this.querySelector('button[type="submit"]');
      const formElements = this.querySelectorAll('input, select, button');
      formElements.forEach(el => el.disabled = true);
      submitBtn.textContent = 'Êèê‰∫§‰∏≠...';
      
      // Êèê‰∫§ËØ∑Ê±Ç
      fetch('/youtube', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        // ÈáçÊñ∞ÂêØÁî®Ë°®ÂçïÂÖÉÁ¥†
        formElements.forEach(el => el.disabled = false);
        submitBtn.textContent = 'Êèê‰∫§ËÆ¢Âçï';
        
        if (data.success) {
          // ËÆ¢ÂçïÊèê‰∫§ÊàêÂäü
          showCustomAlert(data.message, 'success');
          orderForm.reset();
          
          // Âà∑Êñ∞ËÆ¢ÂçïÂàóË°®
          loadOrders(false);
          
          // Êõ¥Êñ∞‰ΩôÈ¢ùÊòæÁ§∫
          if (data.balance !== undefined) {
            updateBalanceDisplay(data.balance, data.credit_limit);
          }
        } else {
          // ËÆ¢ÂçïÊèê‰∫§Â§±Ë¥•
          showCustomAlert(data.error, 'error');
          
          // Êõ¥Êñ∞‰ΩôÈ¢ùÊòæÁ§∫ÔºàÂ¶ÇÊûúAPIËøîÂõû‰∫Ü‰ΩôÈ¢ù‰ø°ÊÅØÔºâ
          if (data.balance !== undefined) {
            updateBalanceDisplay(data.balance, data.credit_limit);
          }
        }
      })
      .catch(error => {
        console.error('Êèê‰∫§ËÆ¢ÂçïÊó∂Âá∫Èîô:', error);
        showCustomAlert('ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï', 'error');
        
        // ÈáçÊñ∞ÂêØÁî®Ë°®ÂçïÂÖÉÁ¥†
        formElements.forEach(el => el.disabled = false);
        submitBtn.textContent = 'Êèê‰∫§ËÆ¢Âçï';
      });
    });
    
    // Âú®Safari‰∏≠‰πüÊòæÁ§∫‰∏ãÊãâËèúÂçï
    document.addEventListener('click', function(e) {
      const dropdown = document.getElementById('userDropdown');
      if (!e.target.closest('.dropdown') && dropdown.classList.contains('show')) {
        dropdown.classList.remove('show');
      }
    });
  });
  
  // Âä†ËΩΩËÆ¢Âçï
  async function loadOrders(silent = true) {
    try {
      // ÊòæÁ§∫Âà∑Êñ∞ÊåáÁ§∫Âô®
      const refreshIndicator = document.getElementById('refreshIndicator');
      if (!silent) {
        refreshIndicator.classList.add('show');
      }
      
      // Ëé∑ÂèñÊ≤πÁÆ°‰ºöÂëòËÆ¢Âçï
      const response = await fetch('/api/orders?product_type=youtube');
      
      if (!response.ok) {
        console.error('Ëé∑ÂèñËÆ¢ÂçïÂ§±Ë¥•', response.status);
        if (!silent) refreshIndicator.classList.remove('show');
        return;
      }
      
      const data = await response.json();
      
      if (data.success) {
        // Ê£ÄÊü•ËÆ¢ÂçïÊòØÂê¶ÊúâÂèòÂåñ
        const newOrdersHash = JSON.stringify(data.orders);
        if (newOrdersHash === lastOrdersHash) {
          if (!silent) refreshIndicator.classList.remove('show');
          return;
        }
        
        lastOrdersHash = newOrdersHash;
        allOrders = data.orders;
        
        renderOrders(allOrders);
        
        // Êõ¥Êñ∞‰ªäÊó•ËÆ¢ÂçïÊÄªÈáè
        if (data.today_total) {
          document.getElementById('today-total').textContent = `‰ªäÊó•ËÆ¢Âçï: ${data.today_total}`;
        }
      }
      
      if (!silent) {
        setTimeout(() => {
          refreshIndicator.classList.remove('show');
        }, 500);
      }
    } catch (error) {
      console.error('Ëé∑ÂèñËÆ¢ÂçïÂàóË°®Â§±Ë¥•:', error);
      if (!silent) {
        document.getElementById('refreshIndicator').classList.remove('show');
      }
    }
  }
  
  // Ê∏≤ÊüìËÆ¢ÂçïÂàóË°®
  function renderOrders(orders) {
    const ordersContainer = document.getElementById('orders-container');
    const loadMoreContainer = document.getElementById('load-more-container');
    
    if (!orders || orders.length === 0) {
      ordersContainer.innerHTML = '<div class="no-orders">ÊöÇÊó†Ê≤πÁÆ°‰ºöÂëòÂÖÖÂÄºËÆ¢Âçï</div>';
      loadMoreContainer.style.display = 'none';
      return;
    }
    
    // ÊòæÁ§∫ÈôêÂÆöÊï∞ÈáèÁöÑËÆ¢Âçï
    const ordersToDisplay = orders.slice(0, displayedOrders);
    
    if (viewMode === 'grid') {
      // ÁΩëÊ†ºËßÜÂõæ
      ordersContainer.innerHTML = '<div class="order-list-container">' +
        ordersToDisplay.map(order => createOrderGridItem(order)).join('') +
        '</div>';
    } else {
      // Ë°®Ê†ºËßÜÂõæ
      ordersContainer.innerHTML = createOrderTable(ordersToDisplay);
    }
    
    // ÊòØÂê¶ÊòæÁ§∫"ÊòæÁ§∫Êõ¥Â§ö"ÊåâÈíÆ
    loadMoreContainer.style.display = orders.length > displayedOrders ? 'block' : 'none';
  }
  
  // ÂàõÂª∫ËÆ¢ÂçïÁΩëÊ†ºÈ°π
  function createOrderGridItem(order) {
    const canCancel = order.status === 'submitted' && (isAdmin || order.creator === userId);
    
    let orderItem = `
      <div class="order-list-item">
        <h4>ËÆ¢Âçï #${order.id}</h4>
        <p class="account">Ë¥¶Âè∑Ôºö${order.account}</p>
        <p class="package">Â•óÈ§êÔºö‰∏™‰∫∫‰ºöÂëò‰∏ÄÂπ¥</p>
        <p class="status">Áä∂ÊÄÅÔºö<span class="status-badge status-${order.status}">${order.status_text || order.status}</span></p>
        <div class="time-info">
          <p class="time">ÂàõÂª∫Êó∂Èó¥Ôºö${order.created_at}</p>
          ${order.accepted_at ? `<p class="time">Êé•ÂçïÊó∂Èó¥Ôºö${order.accepted_at}</p>` : ''}
          ${order.completed_at ? `<p class="time">ÂÆåÊàêÊó∂Èó¥Ôºö${order.completed_at}</p>` : ''}
          ${order.accepted_at && !order.completed_at && order.status === 'accepted' ? 
            `<div style="margin:10px 0"><button onclick="urgeOrder(${order.id})" class="btn btn-primary btn-sm">ÂÇ¨Âçï</button></div>` : ''}
        </div>
        ${order.fail_reason ? `<p class="reason">${order.fail_reason}</p>` : ''}
        ${canCancel ? 
          `<div style="margin:10px 0"><button onclick="cancelOrder(${order.id}, this)" class="btn btn-danger btn-sm">Êí§ÈîÄËÆ¢Âçï</button></div>` : ''}
      </div>
    `;
    
    return orderItem;
  }
  
  // ÂàõÂª∫ËÆ¢ÂçïË°®Ê†º
  function createOrderTable(orders) {
    return `
      <table class="orders-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Ë¥¶Âè∑</th>
            <th>Â•óÈ§ê</th>
            <th>Áä∂ÊÄÅ</th>
            <th>ÂàõÂª∫Êó∂Èó¥</th>
            <th>Êìç‰Ωú</th>
          </tr>
        </thead>
        <tbody>
          ${orders.map(order => {
            const canCancel = order.status === 'submitted' && (isAdmin || order.creator === userId);
            return `
              <tr>
                <td>#${order.id}</td>
                <td>${order.account}</td>
                <td>‰∏™‰∫∫‰ºöÂëò‰∏ÄÂπ¥</td>
                <td><span class="status-badge status-${order.status}">${order.status_text || order.status}</span></td>
                <td>${order.created_at}</td>
                <td>
                  ${order.accepted_at && !order.completed_at && order.status === 'accepted' ? 
                    `<button onclick="urgeOrder(${order.id})" class="btn btn-primary btn-sm">ÂÇ¨Âçï</button>` : ''}
                  ${canCancel ? 
                    `<button onclick="cancelOrder(${order.id}, this)" class="btn btn-danger btn-sm">Êí§ÈîÄ</button>` : ''}
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    `;
  }
  
  // Âä†ËΩΩÊõ¥Â§öËÆ¢Âçï
  function loadMoreOrders() {
    displayedOrders += 5;
    renderOrders(allOrders);
  }
  
  // Êõ¥Êñ∞‰ΩôÈ¢ùÊòæÁ§∫
  function updateBalanceDisplay(balance, creditLimit) {
    const balanceBadge = document.getElementById('balanceBadge');
    
    if (balanceBadge) {
      // Êõ¥Êñ∞È°∂ÈÉ®‰ΩôÈ¢ùÂæΩÁ´†
      balanceBadge.className = 'balance-badge' + (balance < 0 ? ' negative' : '');
      balanceBadge.innerHTML = `‰ΩôÈ¢ù: ${balance} ÂÖÉ<a href="/recharge" class="recharge-btn">ÂÖÖÂÄº</a>`;
      
      // Êõ¥Êñ∞Â∫ïÈÉ®‰ø°ÊÅØÊ†è
      const balanceInfoBar = document.getElementById('balanceInfoBar');
      if (balanceInfoBar) {
        balanceInfoBar.style.display = 'block';
        balanceInfoBar.innerHTML = `ÂΩìÂâç‰ΩôÈ¢ùÔºö${balance} ÂÖÉ` + (creditLimit > 0 ? ` &nbsp;&nbsp;ÂèØÈÄèÊîØÈ¢ùÂ∫¶Ôºö${creditLimit} ÂÖÉ` : '');
      }
    }
  }
  
  // ÂÇ¨ÂçïÔºàÂΩìËÆ¢ÂçïÊé•ÂçïË∂ÖËøá20ÂàÜÈíüÊú™ÂÆåÊàêÊó∂Ôºâ
  async function urgeOrder(orderId) {
    if (!confirm('ÊÇ®Á°ÆÂÆöË¶ÅÂÇ¨‰øÉÊ≠§ËÆ¢ÂçïÂêóÔºüËøôÂ∞ÜÂêëÂçñÂÆ∂ÂèëÈÄÅÂÇ¨ÂçïÈÄöÁü•„ÄÇ')) return;
    
    try {
      const resp = await fetch(`/orders/urge/${orderId}`, { method: 'POST' });
      const result = await resp.json();
      
      if (result.success) {
        showCustomAlert('ÂÇ¨ÂçïÈÄöÁü•Â∑≤ÂèëÈÄÅÁªôÂçñÂÆ∂', 'success');
      } else {
        alert(result.error || 'ÂÇ¨ÂçïÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
      }
    } catch (e) {
      console.error('ÂÇ¨ÂçïÂ§±Ë¥•', e);
      alert('ÂÇ¨ÂçïÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
    }
  }
  
  // Êí§ÈîÄËÆ¢Âçï
  async function cancelOrder(id, buttonElement) {
    if (!confirm('Á°ÆÂÆöË¶ÅÊí§ÈîÄÊ≠§ËÆ¢ÂçïÂêóÔºü')) return;
    
    // Á¶ÅÁî®ÊåâÈíÆ
    buttonElement.disabled = true;
    buttonElement.textContent = 'Êí§ÈîÄ‰∏≠...';
    
    try {
      const resp = await fetch('/orders/cancel/' + id, { method: 'POST' });
      if (resp.ok) {
        // Á´ãÂç≥Êõ¥Êñ∞ÊòæÁ§∫
        await loadOrders(false);
        showCustomAlert('ËÆ¢ÂçïÂ∑≤Êí§ÈîÄ', 'success');
      } else {
        showCustomAlert('Êí§ÈîÄÂ§±Ë¥•', 'error');
        buttonElement.disabled = false;
        buttonElement.textContent = 'Êí§ÈîÄËÆ¢Âçï';
      }
    } catch (e) {
      showCustomAlert('Êí§ÈîÄÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
      buttonElement.disabled = false;
      buttonElement.textContent = 'Êí§ÈîÄËÆ¢Âçï';
    }
  }
  
  // Ëá™Âä®Âà∑Êñ∞ÁÆ°ÁêÜ
  function startAutoRefresh() {
    stopAutoRefresh(); // ÂÖàÂÅúÊ≠¢Áé∞ÊúâÁöÑ
    autoRefreshInterval = setInterval(() => {
      // Â¶ÇÊûúÊ≤°ÊúâÊêúÁ¥¢ÂÖ≥ÈîÆËØçÔºåÂàôËá™Âä®Âà∑Êñ∞
      if (!searchKeyword) {
        loadOrders(true);
      }
    }, 5000);
  }
  
  function stopAutoRefresh() {
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
      autoRefreshInterval = null;
    }
  }
  
  // Ëá™ÂÆö‰πâÊèêÁ§∫Ê°Ü
  function showCustomAlert(message, type = 'success') {
    const alert = document.getElementById('customAlert');
    const icon = alert.querySelector('.custom-alert-icon');
    const messageEl = alert.querySelector('.custom-alert-message');
    
    alert.className = 'custom-alert';
    alert.classList.add(type);
    
    if (type === 'success') {
      icon.innerHTML = '‚úÖ';
    } else if (type === 'error') {
      icon.innerHTML = '‚ùå';
    } else if (type === 'warning') {
      icon.innerHTML = '‚ö†Ô∏è';
    }
    
    messageEl.textContent = message;
    alert.style.display = 'flex';
    
    // 5ÁßíÂêéËá™Âä®ÈöêËóè
    setTimeout(hideCustomAlert, 5000);
  }
  
  function hideCustomAlert() {
    document.getElementById('customAlert').style.display = 'none';
  }
</script>
</body>
</html> 